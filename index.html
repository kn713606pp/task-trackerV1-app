<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧週報平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .task-card { 
            transition: box-shadow 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #6366f1);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.45);
        }
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
        }
        .tab-inactive { 
            color: #475569;
            background-color: transparent;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        mark {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 3px;
            color: #713f12;
        }
        .ai-btn-enabled {
             background-color: #f0fdfa !important;
             color: #0f766e !important;
        }
        .ai-btn-enabled:hover {
             background-color: #ccfbf1 !important;
        }
        .category-tab .remove-category-btn, .category-tab .export-category-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .category-tab:hover .remove-category-btn, .category-tab:hover .export-category-btn {
            opacity: 1;
        }
        
        #welcome-overlay { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #welcome-overlay.visible { opacity: 1; visibility: visible; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-animate { animation: fadeIn 0.8s ease-out forwards; }
        .spinner { border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .priority-緊急 { border-color: #ef4444; }
        .priority-高 { border-color: #f97316; }
        .priority-中 { border-color: #3b82f6; }
        .priority-低 { border-color: #8b5cf6; }

        .priority-badge-緊急 { background-color: #fef2f2; color: #b91c1c; }
        .priority-badge-高 { background-color: #fff7ed; color: #c2410c; }
        .priority-badge-中 { background-color: #eff6ff; color: #1d4ed8; }
        .priority-badge-低 { background-color: #f5f3ff; color: #6d28d9; }

        .sort-btn.sort-active { background-color: white; color: #4f46e5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        #category-tabs { flex-wrap: wrap; gap: 0.5rem; }
        
        #trash-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #trash-container.open { max-height: 500px; }
        .history-item:not(:last-child) { border-bottom: 1px dashed #e2e8f0; }

        /* Custom Input Styles */
        .custom-input {
            background-color: #f0fdf4 !important; /* Tailwind's green-50 */
            border-color: #a7f3d0 !important; /* Tailwind's green-200 */
        }
        .custom-input:focus {
            --tw-ring-color: #34d399 !important; /* emerald-400 */
            border-color: #10b981 !important; /* emerald-500 */
        }
        #undo-bar {
            transform: translateY(120%);
            transition: transform 0.4s ease-in-out;
        }
        #undo-bar.show {
            transform: translateY(0);
        }
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out;
            padding-top: 0;
        }
        .task-card.expanded .task-details {
            max-height: 1000px; /* Large enough to show content */
            padding-top: 1rem;
        }
        .expand-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .task-card.expanded .expand-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="antialiased">
    <!-- Auth Modal -->
    <div id="auth-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[10000] p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-xl p-8 text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">歡迎使用智慧週報平台</h2>
            <p class="text-slate-500 mb-8">請登入以繼續</p>
            <button id="google-signin-btn" class="w-full bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300/80 hover:bg-slate-50 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" fill="#FFC107"></path><path d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" fill="#FF3D00"></path><path d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025A20.01 20.01 0 0 0 24 44z" fill="#4CAF50"></path><path d="M43.611 20.083H42V20H24v8h11.303a12.04 12.04 0 0 1-4.087 7.587l6.19 5.238C44.473 36.231 48 29.023 48 20c0-1.341-.138-2.65-.389-3.917z" fill="#1976D2"></path></svg>
                使用 Google 帳號登入
            </button>
            <div id="auth-error" class="text-sm text-red-600 h-auto min-h-[1.25rem] mt-4"></div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-slate-50/80 backdrop-blur-sm hidden items-center justify-center z-[9999] transition-opacity duration-300">
        <div class="w-16 h-16 border-4 border-slate-300 rounded-full spinner"></div>
    </div>
    <div id="welcome-overlay" class="fixed inset-0 bg-indigo-600 flex items-center justify-center z-[9998]">
        <div class="text-center text-white welcome-animate">
            <h1 class="text-4xl font-bold tracking-wider">歡迎使用</h1>
            <p class="mt-2 text-lg text-indigo-200">智慧週報平台</p>
        </div>
    </div>
    <div id="edit-modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-xl flex flex-col max-h-[90vh]">
             <form id="edit-task-form" class="flex flex-col flex-grow min-h-0">
                <div class="p-6 md:p-8 overflow-y-auto flex-grow">
                    <h2 class="text-xl font-semibold mb-6 text-slate-800">編輯任務</h2>
                    <div class="space-y-5">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="edit-task-priority" class="block text-sm font-medium text-slate-600 mb-1.5">優先度</label>
                                <select id="edit-task-priority" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                            </div>
                            <div>
                                <label for="edit-task-assignee" class="block text-sm font-medium text-slate-600 mb-1.5">負責人</label>
                                <input type="text" id="edit-task-assignee" list="assignee-list" placeholder="手動輸入或選擇..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                            </div>
                            <div>
                                <label for="edit-task-category" class="block text-sm font-medium text-slate-600 mb-1.5">任務分類 (轉移)</label>
                                <div class="flex items-center space-x-2">
                                    <select id="edit-task-category" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                                    <button type="button" id="edit-category-name-btn" title="編輯目前分類名稱" class="p-2.5 text-slate-500 hover:text-indigo-600 bg-slate-100 hover:bg-indigo-100 rounded-lg transition-colors flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    </button>
                                </div>
                            </div>
                             <div>
                                <label for="edit-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">截止日期</label>
                                <input type="date" id="edit-task-due-date" class="custom-input w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                            </div>
                        </div>
                        <div>
                            <label for="edit-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">任務標題</label>
                             <input type="text" id="edit-task-title" placeholder="請輸入任務標題..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition" required>
                        </div>
                        <div>
                            <label for="edit-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">任務描述</label>
                            <textarea id="edit-task-desc" rows="4" placeholder="請輸入任務描述..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-6 py-4 flex justify-end items-center space-x-3 rounded-b-xl flex-shrink-0">
                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-white text-slate-700 rounded-md hover:bg-slate-100 transition text-sm font-semibold border border-slate-300">取消</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="import-modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 modal-overlay">
        <div class="bg-white w-full max-w-xl rounded-xl shadow-xl flex flex-col max-h-[90vh]">
             <div class="p-6 md:p-8 flex-grow overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">匯入任務</h2>
                <p class="text-sm text-slate-500 mb-6">請將從 AI 助理取得的 JSON 文字內容直接貼到下方文字框中，並選擇要匯入的目標分類。</p>
                <div class="mb-4">
                    <label for="import-task-category" class="block text-sm font-medium text-slate-600 mb-1.5">匯入至分類</label>
                    <div class="flex items-center space-x-2">
                        <select id="import-task-category" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                        <button type="button" id="add-category-from-import-btn" class="px-4 py-2.5 text-sm font-semibold text-indigo-600 hover:bg-indigo-100 rounded-md transition-colors flex-shrink-0">+ 新增</button>
                    </div>
                </div>
                <textarea id="import-textarea" rows="8" placeholder="貼上 JSON 內容..." class="custom-input w-full p-4 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></textarea>
                <p id="import-status-message" class="text-sm text-center text-red-600 h-5 mt-2"></p>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end items-center space-x-3 rounded-b-xl flex-shrink-0">
                <button type="button" id="cancel-import-btn" class="px-4 py-2 bg-white text-slate-700 rounded-md hover:bg-slate-100 transition text-sm font-semibold border border-slate-300">取消</button>
                <button type="button" id="confirm-import-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">確認匯入</button>
            </div>
        </div>
    </div>

    <div id="status-reason-modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 modal-overlay">
        <div class="bg-white w-full max-w-md rounded-xl shadow-xl">
             <form id="status-reason-form">
                <div class="p-6 md:p-8">
                    <h2 class="text-xl font-semibold mb-2 text-slate-800">狀態變更</h2>
                    <p class="text-sm text-slate-500 mb-4">請為狀態變更「<span id="new-status-label" class="font-bold"></span>」提供原因 (可選)。</p>
                    <input type="text" id="status-reason-input" placeholder="例如：等待客戶提供資料..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                </div>
                <div class="bg-slate-50 px-6 py-4 flex justify-end items-center space-x-3 rounded-b-xl">
                    <button type="button" id="cancel-status-reason-btn" class="px-4 py-2 bg-white text-slate-700 rounded-md hover:bg-slate-100 transition text-sm font-semibold border border-slate-300">略過</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="history-modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-xl">
             <div class="p-6 md:p-8">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">任務歷史紀錄</h2>
                <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end items-center rounded-b-xl">
                <button type="button" id="close-history-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm font-semibold">關閉</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden opacity-0 transition-opacity duration-500">
      <datalist id="assignee-list"></datalist>
      <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
            <header class="mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 tracking-tight">智慧週報平台</h1>
                        <p class="text-slate-500 mt-3">您的專屬任務管理中心，讓工作流程更順暢。</p>
                    </div>
                    <div id="user-profile" class="text-right">
                        <!-- User info will be injected here -->
                    </div>
                </div>
                <div id="offline-status" class="hidden mt-4 text-sm font-semibold text-amber-800 bg-amber-100 p-3 rounded-lg items-center justify-center max-w-md mx-auto shadow-sm border border-amber-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0v4a1 1 0 112 0V6zM12 14a1 1 0 10-2 0v-1a1 1 0 102 0v1z" clip-rule="evenodd"></path></svg><span id="offline-message"></span></div>
            </header>
            
            <div class="flex justify-center space-x-2 mb-8">
                 <button id="import-btn-main" class="flex items-center px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>貼上內容匯入</button>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/50 mb-10">
                <h2 class="text-xl font-semibold mb-6 text-slate-800">新增一項任務</h2>
                <form id="add-task-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                           <label for="add-task-priority" class="block text-sm font-medium text-slate-600 mb-1.5">優先度</label>
                           <select id="add-task-priority" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                        </div>
                        <div>
                            <label for="add-task-assignee" class="block text-sm font-medium text-slate-600 mb-1.5">負責人</label>
                            <div class="relative flex items-center">
                                <input type="text" id="add-task-assignee" list="assignee-list" placeholder="輸入或選擇..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition pr-10">
                                <div class="absolute right-0 flex items-center pr-2">
                                    <button type="button" id="voice-input-btn-assignee" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="語音輸入負責人">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 2a1 1 0 11-2 0V4a1 1 0 112 0v2zm-4 4a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="add-task-category" class="block text-sm font-medium text-slate-600 mb-1.5">任務分類</label>
                            <select id="add-task-category" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></select>
                        </div>
                         <div>
                            <label for="add-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">截止日期 (可選)</label>
                            <input type="date" id="add-task-due-date" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                        </div>
                    </div>
                    <div>
                        <label for="add-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">任務標題</label>
                        <div class="relative flex items-center">
                            <input type="text" id="add-task-title" placeholder="請輸入任務標題..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition pr-28" required>
                             <div class="absolute right-0 flex items-center space-x-1 pr-2">
                                <button type="button" id="ai-generate-desc-btn" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="AI 產生任務描述"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button>
                                <button type="button" id="paste-btn-title" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="貼上"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
                                <button type="button" id="voice-input-btn-title" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="語音輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 2a1 1 0 11-2 0V4a1 1 0 112 0v2zm-4 4a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center items-center">
                        <button type="button" id="copy-title-desc-btn" class="p-2 text-slate-400 hover:text-indigo-600 rounded-full bg-slate-100 hover:bg-slate-200 transition" title="複製標題至描述">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                            </svg>
                        </button>
                    </div>

                    <div>
                        <label for="add-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">任務描述 (可選)</label>
                        <div class="relative">
                            <textarea id="add-task-desc" rows="3" placeholder="請輸入任務描述..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition pr-24"></textarea>
                            <div class="absolute top-2 right-2 flex items-center space-x-1">
                               <button type="button" id="ai-summarize-btn" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition cursor-not-allowed" title="AI 產生任務標題" disabled><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.707 4.293a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L10 8.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                               <button type="button" id="paste-btn-desc" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="貼上"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
                               <button type="button" id="voice-input-btn-desc" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="語音輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm5 2a1 1 0 11-2 0V4a1 1 0 112 0v2zm-4 4a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg></button>
                               <button type="button" id="image-input-btn" class="p-2 text-slate-400 hover:text-indigo-600 rounded-md transition" title="圖片輸入"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                        <input type="file" id="image-input-file" class="hidden" accept="image/*">
                        <div id="image-preview-container" class="mt-2"></div>
                    </div>
                     <p id="status-message" class="text-sm text-center text-slate-500 h-5"></p>
                    <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300/80">新增任務</button>
                </form>
            </div>

            <div class="mb-6">
                <div class="hidden sm:block">
                    <div class="border-b border-slate-200">
                        <nav id="category-tabs" class="-mb-px flex items-center" aria-label="Tabs"></nav>
                    </div>
                </div>
                 <div class="sm:hidden">
                    <label for="tabs-select" class="sr-only">選擇分類</label>
                    <select id="tabs-select" class="block w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"></select>
                </div>
            </div>

            <div class="mb-6">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input type="search" id="search-input" placeholder="跨分類搜尋標題或描述..." class="custom-input w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-2">
                    <div class="flex justify-between items-center px-2">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>待辦事項</h2>
                        <div id="sort-controls" class="flex items-center space-x-1 bg-slate-100 p-1 rounded-lg">
                             <button data-sort="priority" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">優先度</button>
                             <button data-sort="createdAt" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">建立日期</button>
                             <button data-sort="dueDate" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">到期日期</button>
                        </div>
                    </div>
                    <div id="todo-list" class="space-y-4 min-h-[150px]"></div>
                </div>
                <div class="space-y-2">
                     <div class="flex justify-between items-center px-2">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>已處理</h2>
                        <button id="clear-completed-btn" class="text-sm text-rose-600 hover:text-rose-800 font-semibold transition-colors flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>清除</button>
                    </div>
                    <div id="completed-list" class="space-y-4"></div>
                </div>
            </div>
             <div id="trash-section" class="mt-12">
                <button id="toggle-trash-btn" class="w-full flex justify-between items-center p-4 bg-white rounded-lg shadow-sm border text-left">
                    <span class="font-semibold text-slate-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>垃圾桶</span>
                    <svg id="trash-arrow" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
                <div id="trash-container" class="mt-2 p-4 bg-slate-50/50 rounded-lg">
                    <div id="trash-list" class="space-y-4"></div>
                </div>
            </div>
      </div>
    </div>
    
    <div id="undo-bar" class="fixed bottom-5 left-1/2 -translate-x-1/2 w-auto bg-slate-800 text-white py-3 px-6 rounded-full shadow-lg flex items-center justify-center z-[100]">
        <span id="undo-message" class="text-sm"></span>
        <button id="undo-btn" class="ml-4 text-sm font-semibold text-indigo-300 hover:text-indigo-200">復原</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, enableIndexedDbPersistence, writeBatch, Timestamp, getDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Replace with your actual Firebase project configuration
            const firebaseConfig = {apiKey: "AIzaSyCEydawZbQ4PatrL3grt5SpPrgYYIYcHQ8", authDomain: "task-trackerv1-app.firebaseapp.com", projectId: "task-trackerv1-app", storageBucket: "task-trackerv1-app.firebasestorage.app", messagingSenderId: "224133699343", appId: "1:224133699343:web:7f3bd19aa7b0e9da60d07a", measurementId: "G-M7SL5QMHJ9"};
            
            const STATUSES = { TODO: "待辦事項", HOLD: "暫緩中", COMPLETED: "已完成", DELETED: "已刪除" };
            const CREATOR_COLORS = { "董事長": "border-rose-500", "總經理": "border-sky-500", "使用者": "border-slate-400", "未知": "border-slate-300" };
            const PRIORITIES = { '緊急': 4, '高': 3, '中': 2, '低': 1 };
            const ALL_TASKS_VIEW = '__ALL__';
            
            let state = {
                db: null, auth: null, categories: [], localTasksCache: new Map(),
                activeCategory: localStorage.getItem('activeCategory') || ALL_TASKS_VIEW,
                userProfile: null, // Will hold { uid, email, role }
                currentEditingTaskId: null, currentImageBase64: null, activeRecognitionTarget: null,
                currentSortOrder: 'priority',
                statusChangeContext: null,
                lastImportIds: null, 
                undoTimeout: null,
            };

            let unsubscribeTasks, unsubscribeCategories;

            const dom = {
                authOverlay: document.getElementById('auth-overlay'),
                googleSignInBtn: document.getElementById('google-signin-btn'),
                authError: document.getElementById('auth-error'),
                userProfile: document.getElementById('user-profile'),

                loadingOverlay: document.getElementById('loading-overlay'),
                welcomeOverlay: document.getElementById('welcome-overlay'),
                appContainer: document.getElementById('app-container'),
                offlineStatus: document.getElementById('offline-status'),
                offlineMessage: document.getElementById('offline-message'),
                addTaskForm: document.getElementById('add-task-form'),
                addTaskCategory: document.getElementById('add-task-category'),
                addTaskPriority: document.getElementById('add-task-priority'),
                addTaskAssignee: document.getElementById('add-task-assignee'),
                addTaskTitle: document.getElementById('add-task-title'),
                addTaskDesc: document.getElementById('add-task-desc'),
                addTaskDueDate: document.getElementById('add-task-due-date'),
                todoList: document.getElementById('todo-list'),
                completedList: document.getElementById('completed-list'),
                clearCompletedBtn: document.getElementById('clear-completed-btn'),
                categoryTabsContainer: document.getElementById('category-tabs'),
                tabsSelect: document.getElementById('tabs-select'),
                editModalOverlay: document.getElementById('edit-modal-overlay'),
                editTaskForm: document.getElementById('edit-task-form'),
                editTaskCategory: document.getElementById('edit-task-category'),
                editCategoryNameBtn: document.getElementById('edit-category-name-btn'),
                editTaskPriority: document.getElementById('edit-task-priority'),
                editTaskAssignee: document.getElementById('edit-task-assignee'),
                editTaskDueDate: document.getElementById('edit-task-due-date'),
                editTaskTitle: document.getElementById('edit-task-title'),
                editTaskDesc: document.getElementById('edit-task-desc'),
                cancelEditBtn: document.getElementById('cancel-edit-btn'),
                aiSummarizeBtn: document.getElementById('ai-summarize-btn'),
                voiceInputBtnTitle: document.getElementById('voice-input-btn-title'),
                voiceInputBtnDesc: document.getElementById('voice-input-btn-desc'),
                voiceInputBtnAssignee: document.getElementById('voice-input-btn-assignee'),
                imageInputBtn: document.getElementById('image-input-btn'),
                imageFileInput: document.getElementById('image-input-file'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                statusMessage: document.getElementById('status-message'),
                pasteBtnTitle: document.getElementById('paste-btn-title'),
                pasteBtnDesc: document.getElementById('paste-btn-desc'),
                searchInput: document.getElementById('search-input'),
                aiGenerateDescBtn: document.getElementById('ai-generate-desc-btn'),
                importBtnMain: document.getElementById('import-btn-main'),
                sortControls: document.getElementById('sort-controls'),
                copyTitleToDescBtn: document.getElementById('copy-title-desc-btn'),
                assigneeDatalist: document.getElementById('assignee-list'),
                importModal: document.getElementById('import-modal-overlay'),
                importTextarea: document.getElementById('import-textarea'),
                importTaskCategory: document.getElementById('import-task-category'),
                cancelImportBtn: document.getElementById('cancel-import-btn'),
                confirmImportBtn: document.getElementById('confirm-import-btn'),
                addCategoryFromImportBtn: document.getElementById('add-category-from-import-btn'),
                importStatusMessage: document.getElementById('import-status-message'),
                statusReasonModal: document.getElementById('status-reason-modal-overlay'),
                statusReasonForm: document.getElementById('status-reason-form'),
                statusReasonInput: document.getElementById('status-reason-input'),
                newStatusLabel: document.getElementById('new-status-label'),
                cancelStatusReasonBtn: document.getElementById('cancel-status-reason-btn'),
                historyModal: document.getElementById('history-modal-overlay'),
                historyList: document.getElementById('history-list'),
                closeHistoryBtn: document.getElementById('close-history-btn'),
                trashSection: document.getElementById('trash-section'),
                toggleTrashBtn: document.getElementById('toggle-trash-btn'),
                trashContainer: document.getElementById('trash-container'),
                trashArrow: document.getElementById('trash-arrow'),
                trashList: document.getElementById('trash-list'),
                undoBar: document.getElementById('undo-bar'),
                undoMessage: document.getElementById('undo-message'),
                undoBtn: document.getElementById('undo-btn'),
            };
            
            function startApp() {
                if (!firebaseConfig.apiKey.startsWith("AIza")) {
                    showError("您尚未設定 Firebase！");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);

                // Bind auth event listener immediately
                dom.googleSignInBtn.addEventListener('click', handleGoogleSignIn);

                enableIndexedDbPersistence(state.db).catch(err => console.warn("Firebase Persistence Error:", err.message));
                
                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(state.db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            state.userProfile = { uid: user.uid, ...userDocSnap.data() };
                            dom.authOverlay.style.display = 'none';
                             dom.loadingOverlay.style.display = 'none';
                            bootstrapMainApp();
                        } else {
                            // This case should ideally not be hit with the new Google Sign-In flow,
                            // but as a fallback, we log the user out.
                            console.error("Authenticated user has no profile document. This might happen if Firestore write failed during sign-up. Logging out.");
                            await handleLogout();
                        }
                    } else {
                        state.userProfile = null;
                        if(unsubscribeTasks) unsubscribeTasks();
                        if(unsubscribeCategories) unsubscribeCategories();
                        state.localTasksCache.clear();
                        dom.loadingOverlay.style.display = 'none';
                        dom.authOverlay.style.display = 'flex';
                        dom.appContainer.classList.add('hidden');
                        dom.appContainer.classList.add('opacity-0');
                    }
                });
            }

            function bootstrapMainApp() {
                renderUserProfile();
                dom.welcomeOverlay.classList.add('visible');
                populateSelects();
                setTimeout(() => {
                    dom.welcomeOverlay.classList.remove('visible');
                    setTimeout(() => {
                        dom.appContainer.classList.remove('hidden');
                        dom.appContainer.classList.remove('opacity-0');
                    }, 500);
                }, 1500);
                updateSortButtonsUI();
                listenForCategories();
                listenForTasks();
                initializeDragAndDrop();
                bindEventListeners();
            }

            function renderUserProfile() {
                if (!state.userProfile) {
                    dom.userProfile.innerHTML = '';
                    return;
                }
                const { email, role } = state.userProfile;
                const roleText = role === 'manager' ? '主管' : '成員';
                const roleColor = role === 'manager' ? 'bg-indigo-100 text-indigo-800' : 'bg-slate-100 text-slate-800';
                
                dom.userProfile.innerHTML = `
                    <p class="font-semibold text-slate-700">${email}</p>
                    <div class="flex items-center justify-end mt-1 space-x-2">
                        <span class="px-2 py-0.5 text-xs font-bold rounded-full ${roleColor}">${roleText}</span>
                        <button id="logout-btn" class="text-sm font-semibold text-rose-600 hover:text-rose-500">登出</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            }

            function populateSelects() { const priorityOptions = Object.keys(PRIORITIES).map(p => `<option value="${p}">${p}</option>`).join(''); [dom.addTaskPriority, dom.editTaskPriority].forEach(sel => sel.innerHTML = priorityOptions); }
            
            function initializeDragAndDrop() { 
                new Sortable(dom.todoList, { 
                    animation: 150, 
                    ghostClass: 'sortable-ghost', 
                    onEnd: async (evt) => { 
                        if (state.currentSortOrder !== 'priority') { 
                            state.currentSortOrder = 'priority'; 
                            updateSortButtonsUI(); 
                        } 
                        const taskElements = dom.todoList.querySelectorAll('.task-card'); 
                        const batch = writeBatch(state.db); 
                        taskElements.forEach((el, index) => { 
                            const taskId = el.dataset.id; 
                            if(taskId) { 
                                const taskRef = doc(state.db, 'tasks', taskId); 
                                batch.update(taskRef, { order: index }); 
                            } 
                        }); 
                        try { 
                            await batch.commit(); 
                        } catch (error) { 
                            console.error("更新任務順序失敗:", error); 
                        } 
                    }, 
                }); 
            }
            function highlightText(text, searchTerm) { if (!searchTerm || !text) return text; const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); return text.replace(regex, `<mark>$1</mark>`); }

            function listenForCategories() { const categoriesCollection = collection(state.db, 'categories'); if(unsubscribeCategories) unsubscribeCategories(); unsubscribeCategories = onSnapshot(query(categoriesCollection), (snapshot) => { if (snapshot.empty) { const defaultCategories = ["董總交辦", "行政管理", "運籌管理", "有機植萃", "品質管理"]; const batch = writeBatch(state.db); defaultCategories.forEach(name => { const docRef = doc(collection(state.db, "categories")); batch.set(docRef, { name }); }); batch.commit(); return; } state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); const categoryNames = state.categories.map(c => c.name); if (state.activeCategory !== ALL_TASKS_VIEW && !categoryNames.includes(state.activeCategory)) { state.activeCategory = ALL_TASKS_VIEW; localStorage.setItem('activeCategory', state.activeCategory); } renderCategoriesUI(); renderTasksAndTrash(); }); }
            
            function listenForTasks() { 
                if (!state.userProfile) return;
                
                let tasksQuery;
                const tasksCollectionRef = collection(state.db, 'tasks');

                if (state.userProfile.role === 'manager') {
                    // 主管可以看到所有任務
                    tasksQuery = query(tasksCollectionRef);
                } else {
                    // 成員只能看到自己建立的任務
                    tasksQuery = query(tasksCollectionRef, where("creatorUid", "==", state.userProfile.uid));
                }

                if (unsubscribeTasks) unsubscribeTasks(); 
                unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => { 
                    const currentlyExpanded = new Set();
                    document.querySelectorAll('.task-card.expanded').forEach(card => currentlyExpanded.add(card.dataset.id));

                    const allAssignees = new Set();
                    snapshot.docChanges().forEach((change) => { 
                        const taskData = { status: STATUSES.TODO, ...change.doc.data(), id: change.doc.id }; 
                        if (taskData.assignee && taskData.assignee !== '未指派') {
                            allAssignees.add(taskData.assignee);
                        }
                        if (change.type === "added" || change.type === "modified") { 
                            state.localTasksCache.set(taskData.id, taskData); 
                        } if (change.type === "removed") { 
                            state.localTasksCache.delete(change.doc.id); 
                        } 
                    }); 
                    
                    renderAssigneeDatalist(allAssignees);
                    renderTasksAndTrash(); 

                    currentlyExpanded.forEach(id => {
                        const card = document.querySelector(`.task-card[data-id="${id}"]`);
                        if(card) card.classList.add('expanded');
                    });

                }, (error) => { console.error("監聽任務時發生錯誤:", error); showError("無法讀取雲端資料。"); }); 
            }
            
            function renderCategoriesUI() { 
                const container = dom.categoryTabsContainer; 
                container.innerHTML = ''; 
                const allTasks = Array.from(state.localTasksCache.values()); 
                const todoCounts = allTasks.reduce((acc, task) => { 
                    if (task.status !== STATUSES.COMPLETED && task.status !== STATUSES.DELETED) { 
                        acc[task.category] = (acc[task.category] || 0) + 1; 
                    } 
                    return acc; 
                }, {}); 
                const totalTodoCount = Object.values(todoCounts).reduce((sum, count) => sum + count, 0); 
                
                const createTab = (name, id, isAllTab = false) => { 
                    const count = isAllTab ? totalTodoCount : (todoCounts[name] || 0); 
                    const categoryValue = isAllTab ? ALL_TASKS_VIEW : name; 
                    const isActive = state.activeCategory === categoryValue; 
                    const tabWrapper = document.createElement('div'); 
                    tabWrapper.className = `category-tab relative flex items-center pr-2 rounded-md transition-colors duration-200 ${isActive ? 'tab-active' : 'tab-inactive'}`; 
                    const tabLink = document.createElement('a'); 
                    tabLink.href = '#'; 
                    tabLink.dataset.category = categoryValue; 
                    if (!isAllTab) { 
                        tabLink.dataset.categoryId = id; 
                        tabWrapper.innerHTML += `<button data-category-name="${name}" class="export-category-btn p-1 text-slate-400 hover:text-indigo-600"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>` 
                    } 
                    tabLink.className = `flex-grow pl-4 pr-2 py-2 text-sm font-semibold`; 
                    tabLink.innerHTML = `<span>${name}</span> <span class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full ${isActive ? 'bg-indigo-200 text-indigo-800' : 'bg-slate-200 text-slate-600'}">${count}</span>`; 
                    tabWrapper.prepend(tabLink); 
                    if (!isAllTab) { 
                        const removeButton = document.createElement('button'); 
                        removeButton.className = 'remove-category-btn p-1 rounded-full hover:bg-red-200 hover:text-red-700 text-slate-400'; 
                        removeButton.innerHTML = `<svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`; 
                        removeButton.title = `移除分類 "${name}"`; 
                        removeButton.dataset.categoryId = id; 
                        removeButton.dataset.categoryName = name; 
                        tabWrapper.appendChild(removeButton); 
                    } 
                    container.appendChild(tabWrapper); 
                }; 
                
                createTab('所有任務', null, true); 
                state.categories.forEach(cat => createTab(cat.name, cat.id)); 
                
                const addCategoryButton = document.createElement('button'); 
                addCategoryButton.id = 'add-category-btn'; 
                addCategoryButton.className = "ml-2 px-3 py-1.5 text-sm font-semibold text-indigo-600 hover:bg-indigo-100 rounded-md transition-colors duration-200"; 
                addCategoryButton.textContent = "+ 新增"; 
                container.appendChild(addCategoryButton);

                // This function is now the single source of truth for ALL category dropdowns
                renderAllCategorySelects();
            }
            
            function renderAllCategorySelects() {
                const { categories, activeCategory } = state;
                const selectOptionsHTML = categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');

                // Update form dropdowns
                [dom.addTaskCategory, dom.editTaskCategory].forEach(select => {
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = selectOptionsHTML;
                        // Try to preserve current value, if it still exists
                        if (categories.some(c => c.name === currentVal)) {
                            select.value = currentVal;
                        } else if (activeCategory !== ALL_TASKS_VIEW) {
                            select.value = activeCategory;
                        }
                    }
                });

                // Update import modal dropdown
                if(dom.importTaskCategory) {
                    const currentVal = dom.importTaskCategory.value;
                    dom.importTaskCategory.innerHTML = '<option value="__AUTO__">自動 (依檔案設定)</option>' + selectOptionsHTML;
                    if (categories.some(c => c.name === currentVal)) {
                       dom.importTaskCategory.value = currentVal;
                    }
                }

                // Update mobile navigation dropdown
                if (dom.tabsSelect) {
                    dom.tabsSelect.innerHTML = `<option value="${ALL_TASKS_VIEW}">所有任務</option>` + selectOptionsHTML;
                    dom.tabsSelect.value = activeCategory;
                }
            }

            function renderAssigneeDatalist(assignees) { dom.assigneeDatalist.innerHTML = Array.from(assignees).map(name => `<option value="${name}"></option>`).join(''); }
            
            function renderTasksAndTrash() { const allTasks = Array.from(state.localTasksCache.values()); const activeTasks = allTasks.filter(t => t.status !== STATUSES.DELETED); const deletedTasks = allTasks.filter(t => t.status === STATUSES.DELETED); renderTasks(activeTasks); renderTrash(deletedTasks); }
            function renderTasks(tasksToRender) { dom.todoList.innerHTML = ''; dom.completedList.innerHTML = ''; const searchTerm = dom.searchInput.value.toLowerCase(); const baseTasks = (state.activeCategory === ALL_TASKS_VIEW) ? tasksToRender : tasksToRender.filter(task => task.category === state.activeCategory); const tasksToDisplay = searchTerm ? tasksToRender.filter(task => (task.title || "").toLowerCase().includes(searchTerm) || (task.description || "").toLowerCase().includes(searchTerm)) : baseTasks; const sorters = { priority: (a, b) => (PRIORITIES[b.priority] || 0) - (PRIORITIES[a.priority] || 0) || a.order - b.order, createdAt: (a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0), dueDate: (a, b) => { const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity; const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity; if (dateA === Infinity && dateB === Infinity) return a.order - b.order; return dateA - dateB; } }; const todoTasks = tasksToDisplay.filter(t => t.status === STATUSES.TODO || t.status === STATUSES.HOLD).sort(sorters[state.currentSortOrder]); const processedTasks = tasksToDisplay.filter(t => t.status === STATUSES.COMPLETED).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); todoTasks.forEach(task => dom.todoList.appendChild(createTaskElement(task))); processedTasks.forEach(task => dom.completedList.appendChild(createTaskElement(task))); if (todoTasks.length === 0) { const message = searchTerm ? '找不到符合的待辦任務。' : (state.activeCategory === ALL_TASKS_VIEW ? '所有待辦事項都已處理完畢！' : '這個分類的待辦事項都已處理完畢。'); dom.todoList.innerHTML = `<div class="text-center p-8 bg-white rounded-xl border border-dashed border-slate-300 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-4 text-lg font-semibold text-slate-700">太棒了！</h3><p class="mt-1 text-sm">${message}</p></div>`; } if (processedTasks.length === 0) { dom.completedList.innerHTML = `<p class="text-center text-sm text-slate-500 p-4">暫無已處理的項目</p>`; } }
            function renderTrash(deletedTasks) { dom.trashList.innerHTML = ''; if (deletedTasks.length === 0) { dom.trashList.innerHTML = '<p class="text-center text-sm text-slate-500">垃圾桶是空的。</p>'; return; } deletedTasks.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0)).forEach(task => { const card = document.createElement('div'); card.className = 'bg-white p-3 rounded-md shadow-sm flex justify-between items-center'; card.innerHTML = `<div><p class="font-semibold text-slate-700">${task.title}</p><p class="text-xs text-slate-400">刪除於: ${task.updatedAt ? new Date(task.updatedAt.seconds * 1000).toLocaleString() : '未知'}</p></div><div class="space-x-2"><button data-task-id="${task.id}" class="restore-btn text-sm font-semibold text-indigo-600 hover:text-indigo-800">還原</button><button data-task-id="${task.id}" class="perm-delete-btn text-sm font-semibold text-rose-600 hover:text-rose-800">永久刪除</button></div>`; dom.trashList.appendChild(card); }); }
            
            function createTaskElement(task) {
                const card = document.createElement('div');
                card.dataset.id = task.id;
                card.className = `task-card bg-white p-4 rounded-lg shadow-sm border-l-4 ${CREATOR_COLORS[task.createdBy] || CREATOR_COLORS['未知']} flex flex-col priority-${task.priority}`;
                if (task.status === STATUSES.COMPLETED) card.classList.add('opacity-70');

                const searchTerm = dom.searchInput.value;
                const titleText = (task.title || '').trim() || '無標題任務';
                const titleHTML = highlightText(titleText, searchTerm);

                let statusBadge = '';
                if (task.status === STATUSES.HOLD) {
                    statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 bg-amber-100 text-amber-800 rounded-full">暫緩中</span>`;
                }
                const priorityBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full priority-badge-${task.priority}">${task.priority}</span>`;

                const descHTML = highlightText(task.description || '', searchTerm);
                const imageHTML = task.imageData ? `<img src="${task.imageData}" loading="lazy" class="mt-3 rounded-lg max-h-48 w-auto shadow-sm">` : '';
                const subtasksHTML = renderSubtasks(task);
                const dueDateHTML = task.dueDate ? `<p class="text-xs text-slate-500 mt-1">截止於 ${new Date(task.dueDate).toLocaleDateString('zh-TW')}</p>` : '';
                
                card.innerHTML = `
                    <div class="task-header flex justify-between items-start gap-2 cursor-pointer">
                        <h3 class="font-semibold text-slate-800 pr-2 flex-grow">${titleHTML}</h3>
                        <div class="flex items-center flex-shrink-0 gap-2">
                            ${priorityBadge}
                            ${statusBadge}
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 expand-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="task-details">
                        <p class="text-slate-600 text-sm whitespace-pre-wrap mt-2">${descHTML}</p>
                        ${imageHTML}
                        <div class="subtasks-container mt-4">${subtasksHTML}</div>
                        <div class="mt-3 pt-3 border-t border-slate-200/80 flex justify-between items-center text-xs">
                            <div>
                                <div class="font-medium text-slate-500 flex items-center group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg> 
                                    <span class="assignee-text">${task.assignee || '未指派'}</span>
                                    <button class="inline-edit-assignee-btn p-1 text-slate-400 hover:text-indigo-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    </button>
                                </div>
                                <p class="text-slate-400 mt-1">由 ${task.creatorEmail || '未知使用者'} 於 ${task.createdAt ? new Date(task.createdAt.seconds * 1000).toLocaleDateString() : ''} 建立</p>
                                ${dueDateHTML}
                            </div>
                            <div class="relative flex items-center space-x-1">
                                <button class="history-btn p-1.5 text-slate-400 hover:bg-sky-100 hover:text-sky-600 rounded-full transition-colors" title="檢視歷史紀錄">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>
                                </button>
                                ${generateActionButtons(task)}
                            </div>
                        </div>
                    </div>
                `;
                return card;
            }

            function generateActionButtons(task) { const editButtonHTML = `<button class="edit-btn p-1.5 text-slate-400 hover:bg-indigo-100 hover:text-indigo-600 rounded-full transition-colors" title="編輯任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>`; const deleteButtonHTML = `<button class="delete-btn p-1.5 text-slate-400 hover:bg-rose-100 hover:text-rose-600 rounded-full transition-colors" title="移至垃圾桶"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`; if (task.status === STATUSES.COMPLETED) { return `<button class="action-option p-1.5 text-slate-400 hover:bg-amber-100 hover:text-amber-600 rounded-full transition-colors" title="復原任務" data-status="${STATUSES.TODO}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.707 14.707a1 1 0 01-1.414 0L4.586 12a1 1 0 111.414-1.414L8 12.586l5.293-5.293a1 1 0 111.414 1.414l-6 6z" /></svg></button>` + deleteButtonHTML; } let menuItems = `<a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.COMPLETED}">完成</a>`; if (task.status !== STATUSES.HOLD) { menuItems += `<a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.HOLD}">暫緩</a>`; } else { menuItems = `<a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 action-option" data-status="${STATUSES.TODO}">恢復處理</a>` + menuItems; } const mainAction = `<div class="relative"><button class="action-menu-btn p-1.5 text-slate-400 hover:bg-emerald-100 hover:text-emerald-600 rounded-full transition-colors" title="操作"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg></button><div class="action-menu hidden origin-top-right absolute right-0 bottom-full mb-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"><div class="py-1">${menuItems}</div></div></div>`; return mainAction + editButtonHTML + deleteButtonHTML; }
            function renderSubtasks(task) { let html = ''; if (task.subtasks && task.subtasks.length > 0) { html += '<h4 class="text-sm font-semibold mb-2 text-slate-600">子任務：</h4><ul class="space-y-2 pl-1 mb-3">'; task.subtasks.forEach((subtask, index) => { html += `<li class="flex items-center justify-between group" data-index="${index}"><div class="flex items-center flex-grow"><input type="checkbox" id="subtask-${task.id}-${index}" class="subtask-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${subtask.completed ? 'checked' : ''}><label for="subtask-${task.id}-${index}" class="ml-3 block text-sm text-slate-700 ${subtask.completed ? 'line-through text-slate-400' : ''}">${subtask.text}</label></div><button class="delete-subtask-btn text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition px-2" title="刪除子任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></li>`; }); html += '</ul>'; } if (task.status !== STATUSES.COMPLETED) { html += `<form class="add-subtask-form mt-2 flex items-center space-x-2"><input type="text" placeholder="新增子任務..." class="custom-input flex-grow w-full text-sm px-3 py-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition"><button type="submit" class="text-sm bg-slate-200 text-slate-600 font-semibold py-1.5 px-3 rounded-md hover:bg-slate-300 transition flex-shrink-0">新增</button><button type="button" class="generate-subtasks-btn p-1.5 text-slate-400 hover:bg-indigo-100 hover:text-indigo-600 rounded-full transition-colors" title="AI 產生子任務"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button></form>`; } return html; }
            
            function bindEventListeners() { 
                dom.addTaskForm.addEventListener('submit', handleAddTask); 
                dom.editTaskForm.addEventListener('submit', handleUpdateTask); 
                dom.cancelEditBtn.addEventListener('click', hideEditModal); 
                dom.searchInput.addEventListener('input', renderTasksAndTrash); 
                dom.clearCompletedBtn.addEventListener('click', clearCompletedTasks); 
                dom.editCategoryNameBtn.addEventListener('click', handleEditCategoryName);
                dom.tabsSelect.addEventListener('change', (e) => updateActiveTab(e.target.value));

                dom.todoList.addEventListener('click', handleTaskCardClick);
                dom.completedList.addEventListener('click', handleTaskCardClick);

                dom.categoryTabsContainer.addEventListener('click', handleCategoryActions); 
                
                dom.todoList.addEventListener('submit', handleSubtaskForms); 
                dom.todoList.addEventListener('change', handleSubtaskForms); 
                dom.completedList.addEventListener('submit', handleSubtaskForms);
                dom.completedList.addEventListener('change', handleSubtaskForms); 

                dom.importBtnMain.addEventListener('click', () => { 
                    renderAllCategorySelects();
                    dom.importModal.classList.remove('hidden'); 
                    dom.importModal.classList.add('flex'); 
                }); 
                dom.cancelImportBtn.addEventListener('click', () => { 
                    dom.importModal.classList.add('hidden'); 
                    dom.importModal.classList.remove('flex'); 
                }); 
                dom.confirmImportBtn.addEventListener('click', handleImportFromText); 
                dom.addCategoryFromImportBtn.addEventListener('click', handleAddCategoryFromImport);
                dom.sortControls.addEventListener('click', handleSortClick); 
                dom.copyTitleToDescBtn.addEventListener('click', () => { dom.addTaskDesc.value = dom.addTaskTitle.value; updateAiSummarizeBtnState(); }); 
                dom.statusReasonForm.addEventListener('submit', (e) => { e.preventDefault(); const { taskId, newStatus } = state.statusChangeContext; updateTaskStatus(taskId, newStatus, dom.statusReasonInput.value); dom.statusReasonModal.classList.add('hidden'); dom.statusReasonModal.classList.remove('flex'); dom.statusReasonInput.value = ''; }); 
                dom.cancelStatusReasonBtn.addEventListener('click', () => { const { taskId, newStatus } = state.statusChangeContext; updateTaskStatus(taskId, newStatus); dom.statusReasonModal.classList.add('hidden'); dom.statusReasonModal.classList.remove('flex'); dom.statusReasonInput.value = ''; }); 
                dom.closeHistoryBtn.addEventListener('click', () => { dom.historyModal.classList.add('hidden'); dom.historyModal.classList.remove('flex'); }); 
                dom.toggleTrashBtn.addEventListener('click', () => { dom.trashContainer.classList.toggle('open'); dom.trashArrow.classList.toggle('rotate-180'); }); 
                dom.trashList.addEventListener('click', handleTrashActions); 
                dom.aiGenerateDescBtn.addEventListener('click', handleAiGenerateDesc); 
                dom.aiSummarizeBtn.addEventListener('click', handleAiSummarize); 
                dom.addTaskDesc.addEventListener('input', updateAiSummarizeBtnState); 
                dom.imageInputBtn.addEventListener('click', () => dom.imageFileInput.click()); 
                dom.imageFileInput.addEventListener('change', handleImageUpload); 
                dom.pasteBtnTitle.addEventListener('click', () => handlePaste(dom.addTaskTitle)); 
                dom.pasteBtnDesc.addEventListener('click', () => handlePaste(dom.addTaskDesc)); 
                dom.undoBtn.addEventListener('click', handleUndoImport);
                window.addEventListener('online', () => updateOnlineStatus(true)); 
                window.addEventListener('offline', () => updateOnlineStatus(false)); 
                updateOnlineStatus(navigator.onLine); 
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; 
                if (SpeechRecognition) { const recognition = new SpeechRecognition(); recognition.continuous = false; recognition.lang = 'zh-TW'; recognition.interimResults = false; recognition.onstart = () => { showStatusMessage('正在聆聽...'); }; recognition.onresult = (event) => { if (state.activeRecognitionTarget) { state.activeRecognitionTarget.value += event.results[0][0].transcript; if (state.activeRecognitionTarget === dom.addTaskDesc) updateAiSummarizeBtnState(); } }; recognition.onerror = () => { showStatusMessage('語音辨識錯誤', true); }; recognition.onend = () => { setTimeout(() => showStatusMessage(''), 2000); state.activeRecognitionTarget = null; }; const setupRecognition = (target) => { state.activeRecognitionTarget = target; recognition.start(); }; dom.voiceInputBtnTitle.addEventListener('click', () => setupRecognition(dom.addTaskTitle)); dom.voiceInputBtnDesc.addEventListener('click', () => setupRecognition(dom.addTaskDesc)); dom.voiceInputBtnAssignee.addEventListener('click', () => setupRecognition(dom.addTaskAssignee)); } 
            }
            
            async function handleCategoryActions(e) {
                const tabLink = e.target.closest('a[data-category]');
                if (tabLink) {
                    e.preventDefault();
                    updateActiveTab(tabLink.dataset.category);
                    return;
                }

                const removeBtn = e.target.closest('.remove-category-btn'); 
                if (removeBtn) { 
                    e.stopPropagation(); 
                    const { categoryId, categoryName } = removeBtn.dataset; 
                    if (confirm(`確定要移除分類 "${categoryName}" 嗎？\n此分類下的所有任務將會被永久刪除。`)) { 
                        await removeCategory(categoryId, categoryName); 
                    } 
                    return; 
                } 
                
                if (e.target.id === 'add-category-btn') { 
                    const newCategoryName = prompt("請輸入新的分類名稱："); 
                    if (newCategoryName && newCategoryName.trim()) { 
                        await addCategory(newCategoryName.trim()); 
                    } 
                } 
                
                const exportBtn = e.target.closest('.export-category-btn'); 
                if (exportBtn) { 
                    handleExport(exportBtn.dataset.categoryName); 
                } 
            }
            
            async function addCategory(name) {
                const categoryNames = state.categories.map(c => c.name);
                if (categoryNames.includes(name)) {
                    alert('此分類名稱已存在！');
                    return null;
                }
                try {
                    const docRef = await addDoc(collection(state.db, "categories"), { name });
                    return docRef;
                } catch (error) {
                    console.error("新增分類失敗:", error);
                    return null;
                }
            }

            async function handleAddCategoryFromImport() {
                const newCategoryName = prompt("請輸入新的分類名稱：");
                if (newCategoryName && newCategoryName.trim()) {
                    await addCategory(newCategoryName.trim());
                    // The onSnapshot listener will automatically update the UI
                }
            }

            async function removeCategory(categoryId, categoryName) { const tasksToDeleteQuery = query(collection(state.db, 'tasks'), where("category", "==", categoryName)); const querySnapshot = await getDocs(tasksToDeleteQuery); const batch = writeBatch(state.db); querySnapshot.forEach(doc => { batch.delete(doc.ref); }); batch.delete(doc(state.db, 'categories', categoryId)); await batch.commit(); if (state.activeCategory === categoryName) { updateActiveTab(ALL_TASKS_VIEW); } }
            
            async function updateCategoryName(id, oldName, newName) {
                if (!newName || newName === oldName) return false;
                
                const tasksToUpdateQuery = query(collection(state.db, 'tasks'), where("category", "==", oldName));
                const querySnapshot = await getDocs(tasksToUpdateQuery);
                const batch = writeBatch(state.db);
                
                querySnapshot.forEach(doc => {
                    batch.update(doc.ref, { category: newName });
                });
                batch.update(doc(state.db, 'categories', id), { name: newName });
                
                try {
                    await batch.commit();
                    if (state.activeCategory === oldName) {
                        state.activeCategory = newName; 
                        localStorage.setItem('activeCategory', newName);
                    }
                    return true;
                } catch (error) {
                    console.error("更新分類名稱失敗:", error);
                    return false;
                }
            }

            async function handleEditCategoryName() {
                const currentCategoryName = dom.editTaskCategory.value;
                if (!currentCategoryName) {
                    alert('請先選擇一個要編輯的分類。');
                    return;
                }

                const categoryToEdit = state.categories.find(c => c.name === currentCategoryName);
                if (!categoryToEdit) return;

                const newCategoryName = prompt("請輸入新的分類名稱：", currentCategoryName);

                if (newCategoryName === null || !newCategoryName.trim() || newCategoryName.trim() === currentCategoryName) {
                    return;
                }
                
                const trimmedNewName = newCategoryName.trim();

                if (state.categories.some(c => c.name === trimmedNewName)) {
                    alert('此分類名稱已存在！');
                    return;
                }

                const success = await updateCategoryName(categoryToEdit.id, categoryToEdit.name, trimmedNewName);
                
                if (success) {
                    const currentTask = state.localTasksCache.get(state.currentEditingTaskId);
                    if (currentTask && currentTask.category === currentCategoryName) {
                        dom.editTaskCategory.value = trimmedNewName;
                    }
                }
            }
            
            function handleTaskCardClick(e) {
                const target = e.target;
                const taskCard = target.closest('.task-card');
                if (!taskCard) return;

                const taskId = taskCard.dataset.id;
                
                const isActionButton = target.closest('button, a, input, textarea, form');

                if (isActionButton) {
                    if (target.closest('.delete-btn')) { deleteTask(taskId); } 
                    else if (target.closest('.edit-btn')) { showEditModal(state.localTasksCache.get(taskId)); } 
                    else if (target.closest('.action-menu-btn')) { e.stopPropagation(); const menu = taskCard.querySelector('.action-menu'); if(menu) menu.classList.toggle('hidden'); } 
                    else if (target.closest('.action-option')) { e.preventDefault(); handleStatusChange(taskId, target.closest('.action-option').dataset.status); }
                    else if (target.closest('.history-btn')) { showHistoryModal(state.localTasksCache.get(taskId)); }
                    else if (target.closest('.inline-edit-assignee-btn')) { handleAssigneeInlineEdit(target.closest('.group'), taskId); }
                    else if (target.closest('.delete-subtask-btn')) { 
                        const subtaskIndex = parseInt(target.closest('li').dataset.index);
                        if (confirm('確定要刪除這個子任務嗎？')) {
                            deleteSubtask(taskId, subtaskIndex);
                        }
                    }
                    return; 
                }

                if (target.closest('.task-header')) {
                    taskCard.classList.toggle('expanded');
                }
            }


            function handleAssigneeInlineEdit(container, taskId) {
                const textSpan = container.querySelector('.assignee-text');
                const currentName = textSpan.textContent;

                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.setAttribute('list', 'assignee-list');
                input.className = 'assignee-inline-input custom-input text-xs p-1 w-24';

                textSpan.style.display = 'none';
                container.insertBefore(input, textSpan.nextSibling);
                input.focus();
                input.select();
                
                const saveChanges = async () => {
                    const newName = input.value.trim() || '未指派';
                    if(newName !== currentName) {
                        await updateDoc(doc(state.db, 'tasks', taskId), { assignee: newName });
                    }
                };

                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        input.removeEventListener('blur', saveChanges);
                        input.remove();
                        textSpan.style.display = '';
                    }
                }

                input.addEventListener('blur', saveChanges, { once: true });
                input.addEventListener('keydown', handleKeyDown);
            }

            async function handleAddTask(e) { 
                e.preventDefault(); 
                if (!state.userProfile) return;

                const newOrder = Array.from(state.localTasksCache.values()).filter(t => t.status !== STATUSES.COMPLETED && t.status !== STATUSES.DELETED).length; 
                const newAssignee = dom.addTaskAssignee.value.trim() || '未指派'; 
                const newTask = { 
                    title: dom.addTaskTitle.value, 
                    description: dom.addTaskDesc.value, 
                    dueDate: dom.addTaskDueDate.value, 
                    createdAt: serverTimestamp(), 
                    category: dom.addTaskCategory.value, 
                    creatorUid: state.userProfile.uid,
                    creatorEmail: state.userProfile.email,
                    status: STATUSES.TODO, 
                    order: newOrder, 
                    imageData: state.currentImageBase64, 
                    subtasks: [], 
                    priority: dom.addTaskPriority.value, 
                    assignee: newAssignee, 
                    history: [{ 
                        status: STATUSES.TODO, 
                        reason: '初始建立', 
                        timestamp: Timestamp.now(), 
                        user: state.userProfile.email 
                    }] 
                }; 
                try { await addDoc(collection(state.db, 'tasks'), newTask); dom.addTaskForm.reset(); dom.addTaskCategory.value = (state.activeCategory !== ALL_TASKS_VIEW) ? state.activeCategory : (state.categories[0]?.name || ''); dom.imagePreviewContainer.innerHTML = ''; state.currentImageBase64 = null; updateAiSummarizeBtnState(); } catch (error) { console.error("新增任務失敗:", error); } 
            }

            async function handleUpdateTask(e) { 
                e.preventDefault(); 
                if (!state.currentEditingTaskId) return; 
                const newAssignee = dom.editTaskAssignee.value.trim() || '未指派'; 
                const updatedData = { title: dom.editTaskTitle.value, description: dom.editTaskDesc.value, dueDate: dom.editTaskDueDate.value, category: dom.editTaskCategory.value, priority: dom.editTaskPriority.value, assignee: newAssignee, }; 
                try { await updateDoc(doc(state.db, 'tasks', state.currentEditingTaskId), updatedData); hideEditModal(); } catch (error) { console.error("更新任務失敗:", error); } 
            }
            
            function handleStatusChange(taskId, newStatus) {
                const task = state.localTasksCache.get(taskId);
                if (!task) return;

                if (task.status === STATUSES.TODO && newStatus === STATUSES.HOLD) {
                    state.statusChangeContext = { taskId, newStatus };
                    dom.newStatusLabel.textContent = newStatus;
                    dom.statusReasonModal.classList.remove('hidden');
                    dom.statusReasonModal.classList.add('flex');
                    dom.statusReasonInput.focus();
                } else {
                    updateTaskStatus(taskId, newStatus);
                }
            }

            async function updateTaskStatus(taskId, newStatus, reason = '') { const task = state.localTasksCache.get(taskId); if (!task || !state.userProfile) return; const newHistoryEntry = { status: newStatus, reason: reason.trim() || '狀態變更', timestamp: Timestamp.now(), user: state.userProfile.email }; const updatedHistory = [...(task.history || []), newHistoryEntry]; await updateDoc(doc(state.db, 'tasks', taskId), { status: newStatus, history: updatedHistory, updatedAt: serverTimestamp() }); }
            async function deleteTask(id) { if (!id) return; if (confirm('確定要將此任務移至垃圾桶嗎？')) { await updateTaskStatus(id, STATUSES.DELETED, '移至垃圾桶'); } }
            function showEditModal(task) { if(!task) return; state.currentEditingTaskId = task.id; dom.editTaskTitle.value = task.title || ''; dom.editTaskDesc.value = task.description || ''; dom.editTaskDueDate.value = task.dueDate || ''; dom.editTaskCategory.value = task.category || state.categories[0].name; dom.editTaskPriority.value = task.priority || '中'; dom.editTaskAssignee.value = task.assignee || ''; dom.editModalOverlay.classList.remove('hidden'); dom.editModalOverlay.classList.add('flex'); }
            function hideEditModal() { state.currentEditingTaskId = null; dom.editModalOverlay.classList.add('hidden'); dom.editModalOverlay.classList.remove('flex'); }
            function updateActiveTab(newCategory) { state.activeCategory = newCategory; localStorage.setItem('activeCategory', newCategory); renderCategoriesUI(); renderTasksAndTrash(); }
            function showError(message) { dom.loadingOverlay.innerHTML = `<div class="text-center text-red-700 bg-red-100 p-4 rounded-lg"><h3>錯誤</h3><p>${message}</p></div>`; dom.loadingOverlay.style.display = 'flex'; }
            function handleTrashActions(e) { const restoreBtn = e.target.closest('.restore-btn'); if (restoreBtn) { updateTaskStatus(restoreBtn.dataset.taskId, STATUSES.TODO, '從垃圾桶還原'); return; } const permDeleteBtn = e.target.closest('.perm-delete-btn'); if (permDeleteBtn) { if (confirm('確定要永久刪除這個任務嗎？此操作無法復原。')) { deleteDoc(doc(state.db, 'tasks', permDeleteBtn.dataset.taskId)); } } }
            function showHistoryModal(task) { dom.historyList.innerHTML = ''; if (!task.history || task.history.length === 0) { dom.historyList.innerHTML = '<p class="text-slate-500">沒有歷史紀錄。</p>'; } else { task.history.slice().reverse().forEach(entry => { const item = document.createElement('div'); item.className = 'history-item pb-2'; item.innerHTML = `<p class="font-semibold text-slate-800">${entry.status}</p><p class="text-sm text-slate-600">${entry.reason}</p><p class="text-xs text-slate-400 mt-1">${entry.timestamp ? new Date(entry.timestamp.seconds * 1000).toLocaleString() : '時間未知'} by ${entry.user}</p>`; dom.historyList.appendChild(item); }); } dom.historyModal.classList.remove('hidden'); dom.historyModal.classList.add('flex'); }
            async function clearCompletedTasks() { const tasksToClear = Array.from(state.localTasksCache.values()).filter(t => t.status === STATUSES.COMPLETED && (state.activeCategory === ALL_TASKS_VIEW || t.category === state.activeCategory)); if (tasksToClear.length === 0) return; if (!confirm(`確定要將 ${tasksToClear.length} 個已完成項目移至垃圾桶嗎？`)) return; const batch = writeBatch(state.db); tasksToClear.forEach(task => { const newHistoryEntry = { status: STATUSES.DELETED, reason: '清除已完成項目', timestamp: Timestamp.now(), user: state.userProfile.email }; const updatedHistory = [...(task.history || []), newHistoryEntry]; batch.update(doc(state.db, 'tasks', task.id), { status: STATUSES.DELETED, history: updatedHistory, updatedAt: serverTimestamp() }); }); await batch.commit(); }
            function handleSubtaskForms(e) { const taskCard = e.target.closest('.task-card'); if (!taskCard) return; const taskId = taskCard.dataset.id; if (e.target.matches('input.subtask-checkbox')) { const subtaskIndex = parseInt(e.target.closest('li').dataset.index); toggleSubtaskCompletion(taskId, subtaskIndex); } else if (e.target.closest('.add-subtask-form')) { e.preventDefault(); const form = e.target.closest('.add-subtask-form'); const input = form.querySelector('input[type="text"]'); if (input.value.trim()) { addSubtask(taskId, input.value.trim()); input.value = ''; } } }
            async function addSubtask(taskId, subtaskText) { const task = state.localTasksCache.get(taskId); if(!task) return; const newSubtask = { text: subtaskText, completed: false }; const updatedSubtasks = [...(task.subtasks || []), newSubtask]; await updateDoc(doc(state.db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            async function deleteSubtask(taskId, subtaskIndex) { const task = state.localTasksCache.get(taskId); if(!task) return; const updatedSubtasks = [...task.subtasks]; updatedSubtasks.splice(subtaskIndex, 1); await updateDoc(doc(state.db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            async function toggleSubtaskCompletion(taskId, subtaskIndex) { const task = state.localTasksCache.get(taskId); if(!task) return; const updatedSubtasks = [...task.subtasks]; updatedSubtasks[subtaskIndex].completed = !updatedSubtasks[subtaskIndex].completed; await updateDoc(doc(state.db, 'tasks', taskId), { subtasks: updatedSubtasks }); }
            function updateAiSummarizeBtnState() { const enabled = dom.addTaskDesc.value.trim() !== ''; dom.aiSummarizeBtn.disabled = !enabled; dom.aiSummarizeBtn.classList.toggle('cursor-not-allowed', !enabled); dom.aiSummarizeBtn.classList.toggle('ai-btn-enabled', enabled); }
            function handleImageUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { state.currentImageBase64 = e.target.result; displayImagePreview(state.currentImageBase64); generateDescriptionFromImage(state.currentImageBase64); }; reader.readAsDataURL(file); }
            function displayImagePreview(base64) { dom.imagePreviewContainer.innerHTML = `<div class="relative inline-block group"><img src="${base64}" class="h-24 w-auto rounded-lg shadow-md"><button type="button" class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition">&times;</button></div>`; dom.imagePreviewContainer.querySelector('button').addEventListener('click', () => { state.currentImageBase64 = null; dom.imagePreviewContainer.innerHTML = ''; dom.imageFileInput.value = ''; }); }
            async function handlePaste(targetInput) { try { const text = await navigator.clipboard.readText(); targetInput.value = text; if (targetInput === dom.addTaskDesc) updateAiSummarizeBtnState(); } catch (error) { console.error('貼上失敗:', error); } }
            async function callGemini(payload) { const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API 請求失敗: ${response.status}`); const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || null; } catch (error) { console.error('Gemini API 呼叫失敗:', error); showStatusMessage('AI 功能暫時無法使用。', true); return null; } }
            async function handleAiGenerateDesc(e) { const button = e.currentTarget; const title = dom.addTaskTitle.value; if (!title.trim()) { showStatusMessage('請先輸入任務標題', true); return; } button.disabled = true; showStatusMessage('AI 正在產生描述...'); const prompt = `你是一個專案管理助理，請根據以下任務標題，產生一份簡潔、專業的任務描述，使用繁體中文。任務標題： "${title}"`; const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] }); if (result) { dom.addTaskDesc.value = result.trim(); updateAiSummarizeBtnState(); showStatusMessage('AI 描述已產生！'); } button.disabled = false; }
            async function handleAiSummarize(e) { const button = e.currentTarget; const description = dom.addTaskDesc.value; if (!description.trim()) return; button.disabled = true; showStatusMessage('AI 正在總結標題...'); const prompt = `請將以下任務描述總結成一個不超過 15 個字的精簡標題，使用繁體中文。任務描述： "${description}"`; const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] }); if (result) { dom.addTaskTitle.value = result.replace(/["'「」]/g, '').trim(); showStatusMessage('AI 標題已產生！'); } button.disabled = false; }
            async function generateDescriptionFromImage(base64Data) { showStatusMessage('AI 正在分析圖片...'); const payload = { contents: [{ parts: [{ text: "請根據這張圖片，用繁體中文產生一段簡短的任務描述。" }, { inlineData: { mimeType: "image/png", data: base64Data.split(',')[1] } }] }] }; const result = await callGemini(payload); if (result) { dom.addTaskDesc.value = result.trim(); updateAiSummarizeBtnState(); showStatusMessage('已根據圖片產生描述！'); } }
            async function handleGenerateSubtasks(e, task) { const button = e.currentTarget; if (!task.title) { showStatusMessage('任務需要標題才能產生子任務', true); return; } button.disabled = true; const spinner = `<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`; const originalContent = button.innerHTML; button.innerHTML = spinner; const prompt = `你是一個專案管理助理。根據以下主要任務，請將其拆解成 3 到 5 個具體的、可操作的子任務。請僅回傳一個 JSON 格式的陣列，例如：["子任務一", "子任務二"]。\n\n主要任務標題：${task.title}\n主要任務描述：${task.description || '(無描述)'}`; const result = await callGemini({ contents: [{ parts: [{ text: prompt }] }] }); if (result) { try { const subtaskTexts = JSON.parse(result); if (Array.isArray(subtaskTexts)) { const newSubtasks = subtaskTexts.map(text => ({ text, completed: false })); const updatedSubtasks = [...(task.subtasks || []), ...newSubtasks]; await updateDoc(doc(state.db, 'tasks', task.id), { subtasks: updatedSubtasks }); } } catch (err) { console.error("解析 AI 子任務失敗:", err); showStatusMessage('AI 回應格式錯誤', true); } } button.innerHTML = originalContent; button.disabled = false; }
            function showStatusMessage(message, isError = false) { dom.statusMessage.textContent = message; dom.statusMessage.className = `text-sm text-center h-5 ${isError ? 'text-red-600' : 'text-slate-500'}`; if (message) { setTimeout(() => { if (dom.statusMessage.textContent === message) { dom.statusMessage.textContent = ''; } }, 4000); } }
            
            function showImportStatusMessage(message, isError = true) {
                if (!dom.importStatusMessage) return;
                dom.importStatusMessage.textContent = message;
                dom.importStatusMessage.className = `text-sm text-center h-5 mt-2 ${isError ? 'text-red-600' : 'text-emerald-600'}`;
                if (message) {
                    setTimeout(() => {
                        if (dom.importStatusMessage.textContent === message) {
                            dom.importStatusMessage.textContent = '';
                        }
                    }, 5000);
                }
            }

            function updateOnlineStatus(isOnline) { if (isOnline) { dom.offlineStatus.classList.add('hidden'); dom.offlineStatus.classList.remove('flex'); } else { dom.offlineMessage.textContent = '您目前處於離線狀態，所有變更將在恢復連線後自動同步。'; dom.offlineStatus.classList.remove('hidden'); dom.offlineStatus.classList.add('flex'); } }
            function handleSortClick(e) { const button = e.target.closest('.sort-btn'); if (!button) return; state.currentSortOrder = button.dataset.sort; updateSortButtonsUI(); renderTasksAndTrash(); }
            function updateSortButtonsUI() { dom.sortControls.querySelectorAll('.sort-btn').forEach(btn => { const isSelected = btn.dataset.sort === state.currentSortOrder; btn.classList.toggle('sort-active', isSelected); btn.classList.toggle('text-slate-500', !isSelected); }); }
            function handleExport(categoryName) { const tasksToExport = Array.from(state.localTasksCache.values()).filter(task => !categoryName || task.category === categoryName); const dataToExport = { categories: state.categories, tasks: tasksToExport.map(task => { if (task.createdAt && task.createdAt.toDate) { return { ...task, createdAt: task.createdAt.toDate().toISOString() }; } return task; }), }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tasks-backup-${categoryName || 'all'}-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showStatusMessage('資料已成功匯出！'); }
            
            async function handleImportFromText() {
                const jsonText = dom.importTextarea.value;
                const targetCategory = dom.importTaskCategory.value;
                if (!jsonText.trim()) {
                    return showImportStatusMessage('請貼上 JSON 內容');
                }
                try {
                    const data = JSON.parse(jsonText);
                    if (typeof data !== 'object' || data === null || !data.tasks || !Array.isArray(data.tasks)) {
                        throw new Error('無效的格式：內容需包含一個 "tasks" 陣列。');
                    }
                    if (!confirm(`您確定要匯入 ${data.tasks.length} 個任務嗎？`)) return;

                    dom.confirmImportBtn.disabled = true;
                    showImportStatusMessage(`正在匯入 ${data.tasks.length} 個任務...`, false);

                    const batch = writeBatch(state.db);
                    const importedTaskIds = [];
                    const existingCategoryNames = state.categories.map(c => c.name);

                    data.tasks.forEach(task => {
                        const newDocRef = doc(collection(state.db, 'tasks'));
                        importedTaskIds.push(newDocRef.id);
                        
                        let taskTimestamp;
                        if (task.createdAt && typeof task.createdAt === 'string') {
                            const date = new Date(task.createdAt);
                            if (!isNaN(date.getTime())) {
                                taskTimestamp = Timestamp.fromDate(date);
                            } else {
                                taskTimestamp = serverTimestamp();
                            }
                        } else {
                            taskTimestamp = serverTimestamp();
                        }

                        let finalCategory;
                        if (targetCategory !== '__AUTO__') {
                            finalCategory = targetCategory;
                        } else if (task.category && existingCategoryNames.includes(task.category)) {
                            finalCategory = task.category;
                        } else {
                            finalCategory = existingCategoryNames.length > 0 ? existingCategoryNames[0] : '未分類';
                        }

                        const newTaskData = {
                            title: task.title || '無標題任務',
                            description: task.description || '',
                            priority: task.priority || '中',
                            status: task.status || STATUSES.TODO,
                            category: finalCategory,
                            assignee: task.assignee || '未指派',
                            creatorUid: state.userProfile.uid,
                            creatorEmail: state.userProfile.email,
                            createdAt: taskTimestamp,
                            dueDate: task.dueDate || null,
                            subtasks: task.subtasks || [],
                            history: task.history || [{ status: task.status || STATUSES.TODO, reason: '匯入建立', timestamp: Timestamp.now(), user: state.userProfile.email }]
                        };
                        
                        batch.set(newDocRef, newTaskData);
                    });
                    
                    await batch.commit();
                    state.lastImportIds = { tasks: importedTaskIds, categories: [] };
                    dom.importTextarea.value = '';
                    dom.importModal.classList.add('hidden');
                    dom.importModal.classList.remove('flex');
                    showUndoNotification(`成功匯入 ${importedTaskIds.length} 個任務！`);
                } catch (error) {
                    console.error("匯入失敗:", error);
                    showImportStatusMessage(`匯入失敗: ${error.message}`);
                } finally {
                    dom.confirmImportBtn.disabled = false;
                }
            }

            function showUndoNotification(message) {
                if (state.undoTimeout) clearTimeout(state.undoTimeout);
                dom.undoMessage.textContent = message;
                dom.undoBar.classList.add('show');
                state.undoTimeout = setTimeout(() => {
                    dom.undoBar.classList.remove('show');
                    state.lastImportIds = null;
                }, 10000);
            }

            async function handleUndoImport() {
                if (!state.lastImportIds || state.lastImportIds.tasks.length === 0) return;
                
                const batch = writeBatch(state.db);
                state.lastImportIds.tasks.forEach(id => batch.delete(doc(state.db, 'tasks', id)));
                state.lastImportIds.categories.forEach(id => batch.delete(doc(state.db, 'categories', id)));

                try {
                    await batch.commit();
                    if (state.undoTimeout) clearTimeout(state.undoTimeout);
                    dom.undoBar.classList.remove('show');
                    showStatusMessage('已成功復原上次的匯入。');
                    state.lastImportIds = null;
                } catch (error) {
                    console.error('復原匯入失敗:', error);
                    showStatusMessage('復原失敗，請稍後再試。', true);
                }
            }

            // --- Auth Functions ---
            async function handleGoogleSignIn() {
                const provider = new GoogleAuthProvider();
                dom.authError.innerHTML = '';
                try {
                    const result = await signInWithPopup(state.auth, provider);
                    const user = result.user;

                    const userDocRef = doc(state.db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (!userDocSnap.exists()) {
                        const usersCollectionRef = collection(state.db, 'users');
                        const q = query(usersCollectionRef, limit(1));
                        const querySnapshot = await getDocs(q);
                        const isFirstUser = querySnapshot.empty;
                        
                        const newUserProfile = {
                            email: user.email,
                            role: isFirstUser ? 'manager' : 'member',
                            createdAt: serverTimestamp(),
                        };
                        
                        await setDoc(userDocRef, newUserProfile);
                        state.userProfile = { uid: user.uid, ...newUserProfile };
                        
                        dom.authOverlay.style.display = 'none';
                        dom.loadingOverlay.style.display = 'none';
                        bootstrapMainApp();
                    }
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        const hostname = window.location.hostname;
                        let instructionsHTML = `
                            <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 text-left rounded-md" role="alert">
                                <p class="font-bold">設定問題：網域未授權</p>
                                <p class="text-sm">這是 Firebase 的安全設定，請依照以下步驟解決：</p>
                                <ol class="list-decimal list-inside text-sm mt-2 space-y-1">
                                    <li>前往您的 <a href="https://console.firebase.google.com/" target="_blank" class="font-semibold underline text-indigo-600 hover:text-indigo-800">Firebase 控制台</a>。</li>
                                    <li>進入 <strong>Authentication</strong> > <strong>Settings</strong> > <strong>Authorized domains</strong>。</li>
                                    <li>點擊 "Add domain"，然後輸入以下網域：</li>
                        `;
                        if (hostname) {
                           instructionsHTML += `
                                    <li>
                                        <div class="flex items-center space-x-2 my-1">
                                            <strong id="auth-hostname" class="text-indigo-700 bg-slate-200 px-1.5 py-0.5 rounded-md">${hostname}</strong>
                                            <button id="copy-hostname-btn" class="p-1 text-slate-500 hover:text-indigo-600 rounded-md transition-colors" title="複製">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                            </button>
                                        </div>
                                    </li>
                           `;
                        } else {
                            instructionsHTML += `<li>請**手動複製**您瀏覽器網址列中的網域名稱 (例如 ` + '`xxxx.app`' + ` 或 ` + '`localhost`' + `)，並將其新增。</li>`;
                        }
                        instructionsHTML += `
                                    <li>加入後，請重新整理此頁面再試一次。</li>
                                </ol>
                            </div>
                        `;
                        dom.authError.innerHTML = instructionsHTML;
                        
                        if (hostname) {
                            document.getElementById('copy-hostname-btn').addEventListener('click', () => {
                                navigator.clipboard.writeText(hostname).then(() => {
                                   const btn = document.getElementById('copy-hostname-btn');
                                   btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                                   setTimeout(() => {
                                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                                   }, 2000);
                                });
                            });
                        }

                    } else {
                        dom.authError.textContent = 'Google 登入失敗，請稍後再試。';
                    }
                }
            }

            async function handleLogout() {
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeCategories) unsubscribeCategories();
                await signOut(state.auth);
                // onAuthStateChanged will handle UI reset
            }

            startApp();
        });
    </script>
</body>
</html>
