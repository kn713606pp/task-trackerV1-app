<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§é€±å ±å¹³å° - éƒ¨é–€æ¬Šé™ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .task-card { 
            transition: box-shadow 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #6366f1);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.45);
        }
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
        }
        .tab-inactive { 
            color: #475569;
            background-color: transparent;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        mark {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 3px;
            color: #713f12;
        }
        .ai-btn-enabled {
             background-color: #f0fdfa !important;
             color: #0f766e !important;
        }
        .ai-btn-enabled:hover {
             background-color: #ccfbf1 !important;
        }
        .category-tab .remove-category-btn, .category-tab .export-category-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .category-tab:hover .remove-category-btn, .category-tab:hover .export-category-btn {
            opacity: 1;
        }
        
        #welcome-overlay { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #welcome-overlay.visible { opacity: 1; visibility: visible; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-animate { animation: fadeIn 0.8s ease-out forwards; }
        .spinner { border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .priority-ç·Šæ€¥ { border-color: #ef4444; }
        .priority-é«˜ { border-color: #f97316; }
        .priority-ä¸­ { border-color: #3b82f6; }
        .priority-ä½ { border-color: #8b5cf6; }

        .priority-badge-ç·Šæ€¥ { background-color: #fef2f2; color: #b91c1c; }
        .priority-badge-é«˜ { background-color: #fff7ed; color: #c2410c; }
        .priority-badge-ä¸­ { background-color: #eff6ff; color: #1d4ed8; }
        .priority-badge-ä½ { background-color: #f5f3ff; color: #6d28d9; }

        .sort-btn.sort-active { background-color: white; color: #4f46e5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        #category-tabs { flex-wrap: wrap; gap: 0.5rem; }
        
        #trash-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #trash-container.open { max-height: 500px; }
        .history-item:not(:last-child) { border-bottom: 1px dashed #e2e8f0; }

        /* Custom Input Styles */
        .custom-input {
            background-color: #f0fdf4 !important; /* Tailwind's green-50 */
            border-color: #a7f3d0 !important; /* Tailwind's green-200 */
        }
        .custom-input:focus {
            --tw-ring-color: #34d399 !important; /* emerald-400 */
            border-color: #10b981 !important; /* emerald-500 */
        }
        #undo-bar {
            transform: translateY(120%);
            transition: transform 0.4s ease-in-out;
        }
        #undo-bar.show {
            transform: translateY(0);
        }
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out;
            padding-top: 0;
        }
        .task-card.expanded .task-details {
            max-height: 1000px; /* Large enough to show content */
            padding-top: 1rem;
        }
        .expand-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .task-card.expanded .expand-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="antialiased">
    <!-- Google Sign-In -->
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-login_uri="YOUR_LOGIN_URI"
         data-callback="handleCredentialResponse">
    </div>

    <!-- éƒ¨é–€æ¬Šé™ç®¡ç†ç³»çµ± - ç›´æ¥æ•´åˆ -->
    <script>
        // ===== éƒ¨é–€æ¬Šé™ç®¡ç†ç³»çµ± =====
        window.DEPT_PERMISSION_SYSTEM = {
            // ä¿ç•™åŸæœ‰çš„éƒ¨é–€è³‡æ–™ï¼ŒåŠ å…¥æ¬Šé™å±¬æ€§
            departments: {
                'dept_001': { 
                    id: 'dept_001', 
                    name: 'æŠ€è¡“éƒ¨', 
                    color: '#3B82F6', 
                    emoji: 'ğŸ’»',
                    level: 1,
                    parentId: null,
                    manager: 'æŠ€è¡“éƒ¨ç¶“ç†',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_002': { 
                    id: 'dept_002', 
                    name: 'ç”¢å“éƒ¨', 
                    color: '#10B981', 
                    emoji: 'ğŸ“±',
                    level: 1,
                    parentId: null,
                    manager: 'ç”¢å“éƒ¨ç¶“ç†',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_003': { 
                    id: 'dept_003', 
                    name: 'è¨­è¨ˆéƒ¨', 
                    color: '#F59E0B', 
                    emoji: 'ğŸ¨',
                    level: 1,
                    parentId: null,
                    manager: 'è¨­è¨ˆéƒ¨ç¶“ç†',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_004': { 
                    id: 'dept_004', 
                    name: 'è¡ŒéŠ·éƒ¨', 
                    color: '#EF4444', 
                    emoji: 'ğŸ“¢',
                    level: 1,
                    parentId: null,
                    manager: 'è¡ŒéŠ·éƒ¨ç¶“ç†',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_005': { 
                    id: 'dept_005', 
                    name: 'è²¡å‹™éƒ¨', 
                    color: '#8B5CF6', 
                    emoji: 'ğŸ’°',
                    level: 1,
                    parentId: null,
                    manager: 'è²¡å‹™éƒ¨ç¶“ç†',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                }
            },
            
            // è·¨éƒ¨é–€å°ˆæ¡ˆæ¨™ç±¤
            crossProjectTags: {
                'cross_tech_product': {
                    id: 'cross_tech_product',
                    name: 'æŠ€è¡“ç”¢å“å”ä½œ',
                    color: '#8B5CF6',
                    emoji: 'ğŸ”„',
                    departments: ['dept_001', 'dept_002'],
                    description: 'æŠ€è¡“éƒ¨èˆ‡ç”¢å“éƒ¨å”ä½œå°ˆæ¡ˆ'
                },
                'cross_design_marketing': {
                    id: 'cross_design_marketing',
                    name: 'è¨­è¨ˆè¡ŒéŠ·å”ä½œ',
                    color: '#EC4899',
                    emoji: 'ğŸ¨',
                    departments: ['dept_003', 'dept_004'],
                    description: 'è¨­è¨ˆéƒ¨èˆ‡è¡ŒéŠ·éƒ¨å”ä½œå°ˆæ¡ˆ'
                },
                'cross_all_depts': {
                    id: 'cross_all_depts',
                    name: 'å…¨éƒ¨é–€å”ä½œ',
                    color: '#F59E0B',
                    emoji: 'ğŸŒŸ',
                    departments: ['dept_001', 'dept_002', 'dept_003', 'dept_004', 'dept_005'],
                    description: 'è·¨æ‰€æœ‰éƒ¨é–€çš„å¤§å‹å°ˆæ¡ˆ'
                },
                'cross_finance_others': {
                    id: 'cross_finance_others',
                    name: 'è²¡å‹™æ”¯æ´å”ä½œ',
                    color: '#10B981',
                    emoji: 'ğŸ’¼',
                    departments: ['dept_005', 'dept_001', 'dept_002', 'dept_003', 'dept_004'],
                    description: 'è²¡å‹™éƒ¨æ”¯æ´å…¶ä»–éƒ¨é–€å°ˆæ¡ˆ'
                }
            }
        };

        // ç•¶å‰ä½¿ç”¨è€…ï¼ˆæœƒå¾Googleç™»å…¥ç²å–ï¼‰
        window.CURRENT_USER = null;

        // å¾Googleç™»å…¥è¨­å®šä½¿ç”¨è€…æ¬Šé™
        function setupUserFromGoogleLogin(googleUserInfo) {
            const userId = googleUserInfo.id || 'user_' + Date.now();
            const userEmail = googleUserInfo.email || '';
            const userName = googleUserInfo.name || 'ä½¿ç”¨è€…';
            
            // æ ¹æ“šemailæˆ–ä½¿ç”¨è€…è³‡è¨Šè¨­å®šéƒ¨é–€å’Œè§’è‰²
            let department = 'dept_001'; // é è¨­æŠ€è¡“éƒ¨
            let role = 'member'; // é è¨­æˆå“¡
            let canViewAll = false;
            
            // é€™è£¡å¯ä»¥æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´æ¬Šé™é‚è¼¯
            // ä¾‹å¦‚ï¼šæ ¹æ“šemailä¸­çš„éƒ¨é–€è³‡è¨Šã€æˆ–æ˜¯å¾å¾Œç«¯APIç²å–ç­‰
            if (userEmail.includes('manager') || userEmail.includes('admin')) {
                role = 'manager';
                canViewAll = true;
            }
            
            return {
                id: userId,
                name: userName,
                email: userEmail,
                department: department,
                role: role,
                canViewAll: canViewAll,
                googleInfo: googleUserInfo
            };
        }

        // æª¢æŸ¥éƒ¨é–€æ¬Šé™
        function checkDepartmentPermission(userId, action, targetDeptId) {
            const user = window.DEPT_PERMISSION_SYSTEM.users[userId];
            if (!user) return false;
            
            const targetDept = window.DEPT_PERMISSION_SYSTEM.departments[targetDeptId];
            if (!targetDept) return false;
            
            // ç®¡ç†è€…å¯ä»¥æŸ¥çœ‹æ‰€æœ‰éƒ¨é–€
            if (user.canViewAll || user.role === 'manager') {
                return true;
            }
            
            // æˆå“¡åªèƒ½æŸ¥çœ‹è‡ªå·±éƒ¨é–€
            if (user.role === 'member') {
                return user.department === targetDeptId;
            }
            
            return false;
        }

        // æª¢æŸ¥è·¨éƒ¨é–€å°ˆæ¡ˆæ¬Šé™
        function checkCrossProjectPermission(userId, crossProjectTagId) {
            const user = window.DEPT_PERMISSION_SYSTEM.users[userId];
            const crossTag = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[crossProjectTagId];
            
            if (!user || !crossTag) return false;
            
            // ç®¡ç†è€…å¯ä»¥åƒèˆ‡æ‰€æœ‰è·¨éƒ¨é–€å°ˆæ¡ˆ
            if (user.canViewAll || user.role === 'manager') {
                return true;
            }
            
            // æª¢æŸ¥ä½¿ç”¨è€…éƒ¨é–€æ˜¯å¦åœ¨å…è¨±çš„éƒ¨é–€åˆ—è¡¨ä¸­
            return crossTag.departments.includes(user.department);
        }

        // Googleç™»å…¥è™•ç†
        function handleCredentialResponse(response) {
            const responsePayload = parseJwt(response.credential);
            const userInfo = {
                id: responsePayload.sub,
                name: responsePayload.name,
                email: responsePayload.email,
                imageUrl: responsePayload.picture
            };
            
            window.CURRENT_USER = setupUserFromGoogleLogin(userInfo);
            updateUIAfterLogin();
            showNotification('âœ… ç™»å…¥æˆåŠŸï¼', 'success');
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // æ›´æ–°UIç™»å…¥å¾Œ
        function updateUIAfterLogin() {
            const currentUser = window.CURRENT_USER;
            if (!currentUser) return;
            
            // æ›´æ–°ä½¿ç”¨è€…é¡¯ç¤º
            const userProfile = document.getElementById('user-profile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="text-right">
                        <div class="text-sm font-medium text-slate-900">${currentUser.name}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-1">
                            ${window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.emoji || 'ğŸ‘¤'}
                            ${window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.name || 'æœªçŸ¥éƒ¨é–€'}
                        </div>
                        <div class="text-xs text-slate-400">${currentUser.role}</div>
                    </div>
                    <img src="${currentUser.googleInfo.picture || '/api/placeholder/32/32'}" alt="${currentUser.name}" class="w-8 h-8 rounded-full ml-3">
                `;
            }
            
            // é‡æ–°ç”Ÿæˆéƒ¨é–€é¸æ“‡å™¨
            generateDeptSelector();
            generateCrossProjectTags();
            
            // æ›´æ–°æ¬Šé™é¡¯ç¤º
            updatePermissionDisplay();
        }

        // æ›´æ–°æ¬Šé™é¡¯ç¤º
        function updatePermissionDisplay() {
            const currentUser = window.CURRENT_USER;
            if (!currentUser) return;
            
            const statusDiv = document.getElementById('permission-status-display');
            if (statusDiv) {
                if (currentUser.canViewAll || currentUser.role === 'manager') {
                    statusDiv.innerHTML = 'âœ… å®Œæ•´ç®¡ç†æ¬Šé™';
                    statusDiv.className = 'text-xs text-green-600 mt-1';
                } else {
                    const deptName = window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.name;
                    statusDiv.innerHTML = `ğŸ‘¥ ${deptName} æˆå“¡æ¬Šé™`;
                    statusDiv.className = 'text-xs text-blue-600 mt-1';
                }
            }
        }

        // ç”Ÿæˆéƒ¨é–€é¸æ“‡å™¨
        function generateDeptSelector() {
            const select = document.getElementById('task-dept');
            if (!select) return;
            
            const currentUser = window.CURRENT_USER || window.DEPT_PERMISSION_SYSTEM.users['user_member'];
            const departments = Object.values(window.DEPT_PERMISSION_SYSTEM.departments);
            
            // åªé¡¯ç¤ºç•¶å‰ä½¿ç”¨è€…æœ‰æ¬Šé™çš„éƒ¨é–€
            const allowedDepts = departments.filter(dept => {
                return checkDepartmentPermission(currentUser.id, 'create', dept.id);
            });
            
            let options = '<option value="">ğŸ¢ é¸æ“‡éƒ¨é–€ï¼ˆå…¬é–‹ï¼‰</option>';
            
            allowedDepts.forEach(dept => {
                options += `<option value="${dept.id}" data-emoji="${dept.emoji}" data-color="${dept.color}">
                    ${dept.emoji} ${dept.name}
                </option>`;
            });
            
            select.innerHTML = options;
        }

        // ç”Ÿæˆè·¨éƒ¨é–€å°ˆæ¡ˆæ¨™ç±¤
        function generateCrossProjectTags() {
            const container = document.getElementById('cross-project-tags');
            if (!container) return;
            
            const currentUser = window.CURRENT_USER || window.DEPT_PERMISSION_SYSTEM.users['user_member'];
            const crossTags = window.DEPT_PERMISSION_SYSTEM.crossProjectTags;
            
            let html = '';
            
            Object.values(crossTags).forEach(tag => {
                const hasPermission = checkCrossProjectPermission(currentUser.id, tag.id);
                
                if (hasPermission) {
                    html += `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer hover:scale-105 transition-transform cross-dept-tag" 
                              data-tag-id="${tag.id}"
                              style="background-color: ${tag.color}20; color: ${tag.color}; border: 1px dashed ${tag.color};"
                              onclick="toggleCrossProjectTag(this)"
                              title="${tag.description}">
                            ${tag.emoji} ${tag.name}
                        </span>
                    `;
                }
            });
            
            container.innerHTML = html;
            updateSelectedCrossTags();
        }

        // åˆ‡æ›è·¨éƒ¨é–€å°ˆæ¡ˆæ¨™ç±¤
        function toggleCrossProjectTag(element) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                element.style.backgroundColor = element.style.color;
                element.style.color = 'white';
                element.style.borderStyle = 'solid';
            } else {
                element.style.backgroundColor = element.style.color + '20';
                element.style.color = element.style.color;
                element.style.borderStyle = 'dashed';
            }
            
            updateSelectedCrossTags();
        }

        // æ›´æ–°å·²é¸æ“‡çš„è·¨éƒ¨é–€æ¨™ç±¤é¡¯ç¤º
        function updateSelectedCrossTags() {
            const container = document.getElementById('selected-cross-tags');
            const selectedTags = document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected');
            
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-slate-400 text-xs">æœªé¸æ“‡è·¨éƒ¨é–€å°ˆæ¡ˆ</span>';
            } else {
                let html = '<div class="flex flex-wrap gap-1">';
                selectedTags.forEach(tag => {
                    const tagId = tag.getAttribute('data-tag-id');
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        html += `<span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                        style="background-color: ${tagData.color}; color: white;">
                            ${tagData.emoji} ${tagData.name}
                        </span>`;
                    }
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const colors = {
                success: 'background-color: #10B981; color: white;',
                error: 'background-color: #EF4444; color: white;',
                warning: 'background-color: #F59E0B; color: white;',
                info: 'background-color: #3B82F6; color: white;'
            };
            
            notification.style.cssText += colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</head>
<body class="antialiased">
    <!-- Google Sign-In Button -->
    <div class="g_id_signin" 
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>

    <!-- éƒ¨é–€æ¬Šé™æ§åˆ¶é¢æ¿ -->
    <div id="dept-control-panel" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-lg mb-6 shadow-lg">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <h3 class="text-lg font-semibold mb-2">ğŸ” éƒ¨é–€æ¬Šé™æ§åˆ¶ä¸­å¿ƒ</h3>
                <div class="flex items-center gap-3 flex-wrap">
                    <span><strong>ä½¿ç”¨è€…ï¼š</strong> <span id="current-user-name">æœªç™»å…¥</span></span>
                    <span id="current-user-dept" class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-white bg-opacity-20">
                        ğŸ‘¤ æœªè¨­å®š
                    </span>
                    <span id="permission-status-display" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">
                        è«‹å…ˆç™»å…¥
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div>
                    <label class="block text-xs opacity-80 mb-1">ğŸ” éƒ¨é–€ç¯©é¸</label>
                    <div id="dept-filter-container">
                        <select id="enterprise-dept-filter" class="bg-white bg-opacity-20 border border-white border-opacity-30 rounded px-3 py-1 text-sm text-white">
                            <option value="">ğŸ¢ å…¨éƒ¨éƒ¨é–€</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white bg-opacity-10 p-2 rounded">
                    <div class="text-xs opacity-80">æ¬Šé™ç‹€æ…‹</div>
                    <div id="permission-scope" class="text-sm font-semibold">æª¢è¦–ä¸­</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 tracking-tight">æ™ºæ…§é€±å ±å¹³å°</h1>
                    <p class="text-slate-500 mt-3">æ‚¨çš„å°ˆå±¬ä»»å‹™ç®¡ç†ä¸­å¿ƒï¼Œè®“å·¥ä½œæµç¨‹æ›´é †æš¢ã€‚</p>
                </div>
                <div id="user-profile" class="text-right">
                    <!-- ä½¿ç”¨è€…è³‡è¨Šå°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            <div id="offline-status" class="hidden mt-4 text-sm font-semibold text-amber-800 bg-amber-100 p-3 rounded-lg items-center justify-center max-w-md mx-auto shadow-sm border border-amber-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1V8a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span id="offline-message">ç³»çµ±å·²é›¢ç·šï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚</span>
            </div>
        </header>

        <!-- æ–°å¢ä»»å‹™è¡¨å–® - å«éƒ¨é–€é¸æ“‡ -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/50 mb-10">
            <h2 class="text-xl font-semibold mb-6 text-slate-800">æ–°å¢ä¸€é …ä»»å‹™</h2>
            <form id="add-task-form" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="add-task-priority" class="block text-sm font-medium text-slate-600 mb-1.5">å„ªå…ˆåº¦</label>
                        <select id="add-task-priority" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                            <option value="">é¸æ“‡å„ªå…ˆåº¦</option>
                            <option value="ç·Šæ€¥">ç·Šæ€¥</option>
                            <option value="é«˜">é«˜</option>
                            <option value="ä¸­">ä¸­</option>
                            <option value="ä½">ä½</option>
                        </select>
                    </div>
                    <div>
                        <label for="add-task-assignee" class="block text-sm font-medium text-slate-600 mb-1.5">è² è²¬äºº</label>
                        <input type="text" id="add-task-assignee" list="assignee-list" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                    </div>
                    <div>
                        <label for="add-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">æˆªæ­¢æ—¥æœŸ (å¯é¸)</label>
                        <input type="date" id="add-task-due-date" class="custom-input w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1.5">è² è²¬éƒ¨é–€</label>
                        <div id="dept-selection-container">
                            <select id="task-dept" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                                <!-- éƒ¨é–€é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div id="dept-permission-status" class="text-xs text-slate-500 mt-1"></div>
                    </div>
                </div>
                
                <div>
                    <label for="add-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">ä»»å‹™æ¨™é¡Œ</label>
                    <input type="text" id="add-task-title" placeholder="è«‹è¼¸å…¥ä»»å‹™æ¨™é¡Œ..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition" required>
                </div>
                
                <div>
                    <label for="add-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">ä»»å‹™æè¿° (å¯é¸)</label>
                    <textarea id="add-task-desc" rows="3" placeholder="è«‹è¼¸å…¥ä»»å‹™æè¿°..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></textarea>
                </div>
                
                <!-- è·¨éƒ¨é–€å°ˆæ¡ˆæ¨™ç±¤ -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">è·¨éƒ¨é–€å°ˆæ¡ˆæ¨™ç±¤ (å¯é¸)</label>
                    <div style="background-color: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <p style="color: #64748b; font-size: 13px; margin: 0 0 8px 0;">é»æ“Šä¸‹æ–¹æ¨™ç±¤æ·»åŠ è·¨éƒ¨é–€å”ä½œï¼š</p>
                        <div id="cross-project-tags" class="flex flex-wrap gap-2 mb-3">
                            <!-- è·¨éƒ¨é–€æ¨™ç±¤å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <div id="selected-cross-tags" class="min-h-[24px] border-t border-dashed border-slate-300 pt-2">
                            <span class="text-slate-400 text-xs">æœªé¸æ“‡è·¨éƒ¨é–€å°ˆæ¡ˆ</span>
                        </div>
                    </div>
                </div>
                
                <p id="status-message" class="text-sm text-center text-slate-500 h-5"></p>
                <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300/80">æ–°å¢ä»»å‹™</button>
            </form>
        </div>

        <!-- ä»»å‹™åˆ—è¡¨ -->
        <div class="mb-6">
            <div class="flex justify-between items-center px-2 mb-4">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h3.586a1 1 0 01.707.293l.724.724A1 1 0 0111 2H13a1 1 0 100 2H7a3 3 0 00-3 3v1a1 1 0 011 1h4a1 1 0 001-1V6a1 1 0 112 0v1a2 2 0 002 2h8a2 2 0 002-2V5a1 1 0 10-2 0v1H4V5zM3 13a1 1 0 011-1h4a1 1 0 001-1v8a2 2 0 002 2h6a2 2 0 002-2v-8a1 1 0 112 0v8a3 3 0 01-3 3H7a3 3 0 01-3-3v-8z" clip-rule="evenodd" />
                    </svg>å¾…è¾¦äº‹é …
                </h2>
                <div id="sort-controls" class="flex items-center space-x-1 bg-slate-100 p-1 rounded-lg">
                    <button data-sort="priority" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">å„ªå…ˆåº¦</button>
                    <button data-sort="createdAt" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">å»ºç«‹æ—¥æœŸ</button>
                    <button data-sort="dueDate" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">åˆ°æœŸæ—¥æœŸ</button>
                </div>
            </div>
            <div id="todo-list" class="space-y-4 min-h-[150px]">
                <!-- ä»»å‹™å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <div class="space-y-2">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>å·²è™•ç†
                </h2>
                <button id="clear-completed-btn" class="text-sm text-rose-600 hover:text-rose-800 font-semibold transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1V8a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>æ¸…é™¤
                </button>
            </div>
            <div id="completed-list" class="space-y-4">
                <!-- å·²å®Œæˆçš„ä»»å‹™å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- è³‡æ–™æ¸…å–® -->
    <datalist id="assignee-list"></datalist>

    <!-- JavaScript åŠŸèƒ½æ•´åˆ -->
    <script>
        // ===== ç³»çµ±åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // åˆå§‹åŒ–éƒ¨é–€é¸æ“‡å™¨
            generateDeptSelector();
            generateCrossProjectTags();
            
            // è¨­å®šè¡¨å–®æäº¤
            setupFormSubmission();
            
            // è¼‰å…¥ç¾æœ‰ä»»å‹™
            loadExistingTasks();
            
            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            setupEventListeners();
        }

        // ===== éƒ¨é–€åŠŸèƒ½ =====
        function generateDeptSelector() {
            const select = document.getElementById('task-dept');
            if (!select) return;
            
            const departments = Object.values(window.DEPT_PERMISSION_SYSTEM.departments);
            let options = '<option value="">ğŸ¢ é¸æ“‡éƒ¨é–€ï¼ˆå…¬é–‹ï¼‰</option>';
            
            departments.forEach(dept => {
                options += `<option value="${dept.id}" data-emoji="${dept.emoji}" data-color="${dept.color}">
                    ${dept.emoji} ${dept.name}
                </option>`;
            });
            
            select.innerHTML = options;
        }

        function generateCrossProjectTags() {
            const container = document.getElementById('cross-project-tags');
            if (!container) return;
            
            const crossTags = window.DEPT_PERMISSION_SYSTEM.crossProjectTags;
            let html = '';
            
            Object.values(crossTags).forEach(tag => {
                html += `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer hover:scale-105 transition-transform cross-dept-tag" 
                          data-tag-id="${tag.id}"
                          style="background-color: ${tag.color}20; color: ${tag.color}; border: 1px dashed ${tag.color};"
                          onclick="toggleCrossProjectTag(this)"
                          title="${tag.description}">
                        ${tag.emoji} ${tag.name}
                    </span>
                `;
            });
            
            container.innerHTML = html;
            updateSelectedCrossTags();
        }

        function toggleCrossProjectTag(element) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                element.style.backgroundColor = element.style.color;
                element.style.color = 'white';
                element.style.borderStyle = 'solid';
            } else {
                element.style.backgroundColor = element.style.color + '20';
                element.style.color = element.style.color;
                element.style.borderStyle = 'dashed';
            }
            
            updateSelectedCrossTags();
        }

        function updateSelectedCrossTags() {
            const container = document.getElementById('selected-cross-tags');
            const selectedTags = document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected');
            
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-slate-400 text-xs">æœªé¸æ“‡è·¨éƒ¨é–€å°ˆæ¡ˆ</span>';
            } else {
                let html = '<div class="flex flex-wrap gap-1">';
                selectedTags.forEach(tag => {
                    const tagId = tag.getAttribute('data-tag-id');
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        html += `<span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                        style="background-color: ${tagData.color}; color: white;">
                            ${tagData.emoji} ${tagData.name}
                        </span>`;
                    }
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        // ===== è¡¨å–®æäº¤è™•ç† =====
        function setupFormSubmission() {
            const form = document.getElementById('add-task-form');
            if (!form) return;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const currentUser = window.CURRENT_USER;
                if (!currentUser) {
                    showNotification('âŒ è«‹å…ˆç™»å…¥Googleå¸³è™Ÿï¼', 'error');
                    return false;
                }
                
                const deptSelect = document.getElementById('task-dept');
                const selectedDepartment = deptSelect ? deptSelect.value : '';
                
                // æª¢æŸ¥éƒ¨é–€æ¬Šé™
                if (selectedDepartment && !checkDepartmentPermission(currentUser.id, 'create', selectedDepartment)) {
                    showNotification('âŒ æ‚¨æ²’æœ‰åœ¨è©²éƒ¨é–€å‰µå»ºä»»å‹™çš„æ¬Šé™ï¼', 'error');
                    return false;
                }
                
                // æ”¶é›†è·¨éƒ¨é–€æ¨™ç±¤
                const selectedCrossTags = Array.from(document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected'))
                    .map(tag => tag.getAttribute('data-tag-id'));
                
                // å»ºç«‹ä»»å‹™è³‡æ–™
                const taskData = {
                    title: document.getElementById('add-task-title')?.value,
                    description: document.getElementById('add-task-desc')?.value,
                    priority: document.getElementById('add-task-priority')?.value,
                    assignee: document.getElementById('add-task-assignee')?.value,
                    dueDate: document.getElementById('add-task-due-date')?.value,
                    department: selectedDepartment,
                    crossDeptTags: selectedCrossTags,
                    creatorId: currentUser.id,
                    creatorName: currentUser.name,
                    creatorDept: currentUser.department,
                    status: 'todo',
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const newTask = await createTask(taskData);
                    if (newTask) {
                        showNotification('âœ… ä»»å‹™å‰µå»ºæˆåŠŸï¼', 'success');
                        form.reset();
                        updateSelectedCrossTags();
                        loadExistingTasks();
                    }
                } catch (error) {
                    showNotification(`âŒ ä»»å‹™å‰µå»ºå¤±æ•—ï¼š${error.message}`, 'error');
                }
                
                return false;
            };
        }

        // å‰µå»ºä»»å‹™
        async function createTask(taskData) {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const newTask = {
                id: 'task_' + Date.now(),
                ...taskData,
                updatedAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            return newTask;
        }

        // ===== ä»»å‹™è¼‰å…¥èˆ‡é¡¯ç¤º =====
        function loadExistingTasks() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const currentUser = window.CURRENT_USER;
            
            if (!currentUser) {
                // æœªç™»å…¥æ™‚é¡¯ç¤ºæ‰€æœ‰ä»»å‹™
                displayTasks(tasks);
                return;
            }
            
            // ç™»å…¥å¾Œæ ¹æ“šæ¬Šé™éæ¿¾ä»»å‹™
            const filteredTasks = tasks.filter(task => {
                if (!task.department) return true; // æ²’æœ‰éƒ¨é–€çš„ä»»å‹™æ‰€æœ‰äººéƒ½å¯ä»¥çœ‹åˆ°
                
                // æª¢æŸ¥éƒ¨é–€æ¬Šé™
                return checkDepartmentPermission(currentUser.id, 'view', task.department);
            });
            
            displayTasks(filteredTasks);
        }

        function displayTasks(tasks) {
            const todoList = document.getElementById('todo-list');
            const completedList = document.getElementById('completed-list');
            
            if (!todoList || !completedList) return;
            
            todoList.innerHTML = '';
            completedList.innerHTML = '';
            
            const currentUser = window.CURRENT_USER;
            
            tasks.forEach(task => {
                const taskElement = createTaskElement(task, currentUser);
                
                if (task.status === 'completed') {
                    completedList.appendChild(taskElement);
                } else {
                    todoList.appendChild(taskElement);
                }
            });
        }

        function createTaskElement(task, currentUser) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-4 rounded-lg shadow-sm border border-slate-200';
            taskCard.setAttribute('data-task-id', task.id);
            taskCard.setAttribute('data-department', task.department || '');
            
            // æ ¹æ“šæ¬Šé™èª¿æ•´é¡¯ç¤º
            if (task.department && currentUser && !checkDepartmentPermission(currentUser.id, 'view', task.department)) {
                taskCard.style.opacity = '0.6';
                taskCard.style.pointerEvents = 'none';
                taskCard.style.backgroundColor = '#f8fafc';
            }
            
            // éƒ¨é–€æ¨™ç±¤
            let deptTagHtml = '';
            if (task.department) {
                const dept = window.DEPT_PERMISSION_SYSTEM.departments[task.department];
                if (dept) {
                    deptTagHtml = `
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-2 mb-2" 
                              style="background-color: ${dept.color}20; color: ${dept.color}; border: 1px solid ${dept.color};">
                            ${dept.emoji} ${dept.name}
                        </span>
                    `;
                }
            }
            
            // è·¨éƒ¨é–€æ¨™ç±¤
            let crossTagsHtml = '';
            if (task.crossDeptTags && task.crossDeptTags.length > 0) {
                crossTagsHtml = '<div class="flex flex-wrap gap-1 mt-2">';
                task.crossDeptTags.forEach(tagId => {
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        crossTagsHtml += `
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                  style="background-color: ${tagData.color}; color: white;">
                                ${tagData.emoji} ${tagData.name}
                            </span>
                        `;
                    }
                });
                crossTagsHtml += '</div>';
            }
            
            // æ¬Šé™æç¤º
            let permissionNotice = '';
            if (task.department && currentUser && !checkDepartmentPermission(currentUser.id, 'view', task.department)) {
                permissionNotice = `
                    <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600">
                        ğŸ”’ æ‚¨æ²’æœ‰æŸ¥çœ‹æ­¤éƒ¨é–€ä»»å‹™çš„æ¬Šé™
                    </div>
                `;
            }
            
            taskCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        ${deptTagHtml}
                        <h3 class="task-title text-lg font-semibold text-slate-800">${task.title}</h3>
                        ${crossTagsHtml}
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        ${task.priority ? `<span class="priority-badge priority-${task.priority} px-2 py-1 rounded-full text-xs font-medium">${task.priority}</span>` : ''}
                        <button onclick="expandTaskDetails('${task.id}')" class="p-1 text-slate-400 hover:text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 expand-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="task-details">
                    ${task.description ? `<p class="text-slate-600 mb-3">${task.description}</p>` : ''}
                    <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                        ${task.assignee ? `<span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>${task.assignee}</span>` : ''}
                        ${task.dueDate ? `<span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                    </div>
                    ${permissionNotice}
                </div>
                
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-100">
                    <div class="flex gap-2">
                        <button onclick="updateTaskStatus('${task.id}', 'completed')" class="px-3 py-1 bg-emerald-500 text-white text-sm rounded hover:bg-emerald-600 transition-colors">å®Œæˆ</button>
                        <button onclick="editTask('${task.id}')" class="px-3 py-1 bg-slate-500 text-white text-sm rounded hover:bg-slate-600 transition-colors">ç·¨è¼¯</button>
                        <button onclick="deleteTask('${task.id}')" class="px-3 py-1 bg-rose-500 text-white text-sm rounded hover:bg-rose-600 transition-colors">åˆªé™¤</button>
                    </div>
                    <span class="text-xs text-slate-500">å»ºç«‹è€…ï¼š${task.creatorName || 'ç³»çµ±'}</span>
                </div>
            `;
            
            return taskCard;
        }

        // ===== äº‹ä»¶è™•ç† =====
        function setupEventListeners() {
            // éƒ¨é–€ç¯©é¸è®Šæ›´
            const deptFilter = document.getElementById('enterprise-dept-filter');
            if (deptFilter) {
                deptFilter.addEventListener('change', function() {
                    filterTasksByDepartment(this.value);
                });
            }
            
            // å…¶ä»–äº‹ä»¶ç›£è½å™¨
            const clearBtn = document.getElementById('clear-completed-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearCompletedTasks);
            }
        }

        // æ ¹æ“šéƒ¨é–€ç¯©é¸ä»»å‹™
        function filterTasksByDepartment(selectedDeptId) {
            const tasks = document.querySelectorAll('.task-card');
            const currentUser = window.CURRENT_USER;
            
            tasks.forEach(task => {
                const taskDeptId = task.getAttribute('data-department');
                let shouldShow = true;
                
                // éƒ¨é–€ç¯©é¸
                if (selectedDeptId && selectedDeptId !== '') {
                    shouldShow = taskDeptId === selectedDeptId;
                }
                
                // æ¬Šé™æª¢æŸ¥ï¼ˆåªåœ¨æœ‰ä½¿ç”¨è€…ç™»å…¥æ™‚ï¼‰
                if (currentUser && taskDeptId && !checkDepartmentPermission(currentUser.id, 'view', taskDeptId)) {
                    shouldShow = false;
                }
                
                task.style.display = shouldShow ? 'block' : 'none';
                
                // è¦–è¦ºæç¤º
                if (!shouldShow && taskDeptId) {
                    task.classList.add('restricted');
                } else {
                    task.classList.remove('restricted');
                }
            });
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•¸
        function expandTaskDetails(taskId) {
            // å¯¦ä½œä»»å‹™è©³ç´°è³‡è¨Šå±•é–‹åŠŸèƒ½
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.classList.toggle('expanded');
            }
        }

        function updateTaskStatus(taskId, status) {
            // å¯¦ä½œä»»å‹™ç‹€æ…‹æ›´æ–°åŠŸèƒ½
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1) {
                tasks[taskIndex].status = status;
                tasks[taskIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadExistingTasks();
            }
        }

        function editTask(taskId) {
            // å¯¦ä½œä»»å‹™ç·¨è¼¯åŠŸèƒ½
            showNotification('âœ… ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        function deleteTask(taskId) {
            // å¯¦ä½œä»»å‹™åˆªé™¤åŠŸèƒ½
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ')) {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const filteredTasks = tasks.filter(task => task.id !== taskId);
                localStorage.setItem('tasks', JSON.stringify(filteredTasks));
                loadExistingTasks();
                showNotification('âœ… ä»»å‹™å·²åˆªé™¤', 'success');
            }
        }

        function clearCompletedTasks() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„ä»»å‹™å—ï¼Ÿ')) {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const filteredTasks = tasks.filter(task => task.status !== 'completed');
                localStorage.setItem('tasks', JSON.stringify(filteredTasks));
                loadExistingTasks();
                showNotification('âœ… å·²å®Œæˆä»»å‹™å·²æ¸…é™¤', 'success');
            }
        }

        // ===== é€šçŸ¥åŠŸèƒ½ =====
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const colors = {
                success: 'background-color: #10B981; color: white;',
                error: 'background-color: #EF4444; color: white;',
                warning: 'background-color: #F59E0B; color: white;',
                info: 'background-color: #3B82F6; color: white;'
            };
            
            notification.style.cssText += colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // ===== åˆå§‹åŒ– =====
        window.addEventListener('load', function() {
            // åˆå§‹åŒ–ç³»çµ±
            initializeSystem();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å·²ç™»å…¥çš„ä½¿ç”¨è€…
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                window.CURRENT_USER = JSON.parse(savedUser);
                updateUIAfterLogin();
            }
        });
    </script>
</body>
</html>

