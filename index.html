<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧週報平台 - 部門權限版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .task-card { 
            transition: box-shadow 0.2s ease-in-out; 
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #6366f1);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.45);
        }
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .tab-active { 
            color: #4338ca; 
            background-color: #eef2ff;
        }
        .tab-inactive { 
            color: #475569;
            background-color: transparent;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #eef2ff;
            border: 2px dashed #6366f1;
        }
        mark {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 3px;
            color: #713f12;
        }
        .ai-btn-enabled {
             background-color: #f0fdfa !important;
             color: #0f766e !important;
        }
        .ai-btn-enabled:hover {
             background-color: #ccfbf1 !important;
        }
        .category-tab .remove-category-btn, .category-tab .export-category-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .category-tab:hover .remove-category-btn, .category-tab:hover .export-category-btn {
            opacity: 1;
        }
        
        #welcome-overlay { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #welcome-overlay.visible { opacity: 1; visibility: visible; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-animate { animation: fadeIn 0.8s ease-out forwards; }
        .spinner { border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .priority-緊急 { border-color: #ef4444; }
        .priority-高 { border-color: #f97316; }
        .priority-中 { border-color: #3b82f6; }
        .priority-低 { border-color: #8b5cf6; }

        .priority-badge-緊急 { background-color: #fef2f2; color: #b91c1c; }
        .priority-badge-高 { background-color: #fff7ed; color: #c2410c; }
        .priority-badge-中 { background-color: #eff6ff; color: #1d4ed8; }
        .priority-badge-低 { background-color: #f5f3ff; color: #6d28d9; }

        .sort-btn.sort-active { background-color: white; color: #4f46e5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        #category-tabs { flex-wrap: wrap; gap: 0.5rem; }
        
        #trash-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #trash-container.open { max-height: 500px; }
        .history-item:not(:last-child) { border-bottom: 1px dashed #e2e8f0; }

        /* Custom Input Styles */
        .custom-input {
            background-color: #f0fdf4 !important; /* Tailwind's green-50 */
            border-color: #a7f3d0 !important; /* Tailwind's green-200 */
        }
        .custom-input:focus {
            --tw-ring-color: #34d399 !important; /* emerald-400 */
            border-color: #10b981 !important; /* emerald-500 */
        }
        #undo-bar {
            transform: translateY(120%);
            transition: transform 0.4s ease-in-out;
        }
        #undo-bar.show {
            transform: translateY(0);
        }
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out;
            padding-top: 0;
        }
        .task-card.expanded .task-details {
            max-height: 1000px; /* Large enough to show content */
            padding-top: 1rem;
        }
        .expand-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .task-card.expanded .expand-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="antialiased">
    <!-- Google Sign-In -->
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-login_uri="YOUR_LOGIN_URI"
         data-callback="handleCredentialResponse">
    </div>

    <!-- 部門權限管理系統 - 直接整合 -->
    <script>
        // ===== 部門權限管理系統 =====
        window.DEPT_PERMISSION_SYSTEM = {
            // 保留原有的部門資料，加入權限屬性
            departments: {
                'dept_001': { 
                    id: 'dept_001', 
                    name: '技術部', 
                    color: '#3B82F6', 
                    emoji: '💻',
                    level: 1,
                    parentId: null,
                    manager: '技術部經理',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_002': { 
                    id: 'dept_002', 
                    name: '產品部', 
                    color: '#10B981', 
                    emoji: '📱',
                    level: 1,
                    parentId: null,
                    manager: '產品部經理',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_003': { 
                    id: 'dept_003', 
                    name: '設計部', 
                    color: '#F59E0B', 
                    emoji: '🎨',
                    level: 1,
                    parentId: null,
                    manager: '設計部經理',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_004': { 
                    id: 'dept_004', 
                    name: '行銷部', 
                    color: '#EF4444', 
                    emoji: '📢',
                    level: 1,
                    parentId: null,
                    manager: '行銷部經理',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                },
                'dept_005': { 
                    id: 'dept_005', 
                    name: '財務部', 
                    color: '#8B5CF6', 
                    emoji: '💰',
                    level: 1,
                    parentId: null,
                    manager: '財務部經理',
                    viewableBy: ['all'],
                    editableBy: ['manager', 'ceo', 'director']
                }
            },
            
            // 跨部門專案標籤
            crossProjectTags: {
                'cross_tech_product': {
                    id: 'cross_tech_product',
                    name: '技術產品協作',
                    color: '#8B5CF6',
                    emoji: '🔄',
                    departments: ['dept_001', 'dept_002'],
                    description: '技術部與產品部協作專案'
                },
                'cross_design_marketing': {
                    id: 'cross_design_marketing',
                    name: '設計行銷協作',
                    color: '#EC4899',
                    emoji: '🎨',
                    departments: ['dept_003', 'dept_004'],
                    description: '設計部與行銷部協作專案'
                },
                'cross_all_depts': {
                    id: 'cross_all_depts',
                    name: '全部門協作',
                    color: '#F59E0B',
                    emoji: '🌟',
                    departments: ['dept_001', 'dept_002', 'dept_003', 'dept_004', 'dept_005'],
                    description: '跨所有部門的大型專案'
                },
                'cross_finance_others': {
                    id: 'cross_finance_others',
                    name: '財務支援協作',
                    color: '#10B981',
                    emoji: '💼',
                    departments: ['dept_005', 'dept_001', 'dept_002', 'dept_003', 'dept_004'],
                    description: '財務部支援其他部門專案'
                }
            }
        };

        // 當前使用者（會從Google登入獲取）
        window.CURRENT_USER = null;

        // 從Google登入設定使用者權限
        function setupUserFromGoogleLogin(googleUserInfo) {
            const userId = googleUserInfo.id || 'user_' + Date.now();
            const userEmail = googleUserInfo.email || '';
            const userName = googleUserInfo.name || '使用者';
            
            // 根據email或使用者資訊設定部門和角色
            let department = 'dept_001'; // 預設技術部
            let role = 'member'; // 預設成員
            let canViewAll = false;
            
            // 這裡可以根據實際需求調整權限邏輯
            // 例如：根據email中的部門資訊、或是從後端API獲取等
            if (userEmail.includes('manager') || userEmail.includes('admin')) {
                role = 'manager';
                canViewAll = true;
            }
            
            return {
                id: userId,
                name: userName,
                email: userEmail,
                department: department,
                role: role,
                canViewAll: canViewAll,
                googleInfo: googleUserInfo
            };
        }

        // 檢查部門權限
        function checkDepartmentPermission(userId, action, targetDeptId) {
            const user = window.DEPT_PERMISSION_SYSTEM.users[userId];
            if (!user) return false;
            
            const targetDept = window.DEPT_PERMISSION_SYSTEM.departments[targetDeptId];
            if (!targetDept) return false;
            
            // 管理者可以查看所有部門
            if (user.canViewAll || user.role === 'manager') {
                return true;
            }
            
            // 成員只能查看自己部門
            if (user.role === 'member') {
                return user.department === targetDeptId;
            }
            
            return false;
        }

        // 檢查跨部門專案權限
        function checkCrossProjectPermission(userId, crossProjectTagId) {
            const user = window.DEPT_PERMISSION_SYSTEM.users[userId];
            const crossTag = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[crossProjectTagId];
            
            if (!user || !crossTag) return false;
            
            // 管理者可以參與所有跨部門專案
            if (user.canViewAll || user.role === 'manager') {
                return true;
            }
            
            // 檢查使用者部門是否在允許的部門列表中
            return crossTag.departments.includes(user.department);
        }

        // Google登入處理
        function handleCredentialResponse(response) {
            const responsePayload = parseJwt(response.credential);
            const userInfo = {
                id: responsePayload.sub,
                name: responsePayload.name,
                email: responsePayload.email,
                imageUrl: responsePayload.picture
            };
            
            window.CURRENT_USER = setupUserFromGoogleLogin(userInfo);
            updateUIAfterLogin();
            showNotification('✅ 登入成功！', 'success');
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // 更新UI登入後
        function updateUIAfterLogin() {
            const currentUser = window.CURRENT_USER;
            if (!currentUser) return;
            
            // 更新使用者顯示
            const userProfile = document.getElementById('user-profile');
            if (userProfile) {
                userProfile.innerHTML = `
                    <div class="text-right">
                        <div class="text-sm font-medium text-slate-900">${currentUser.name}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-1">
                            ${window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.emoji || '👤'}
                            ${window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.name || '未知部門'}
                        </div>
                        <div class="text-xs text-slate-400">${currentUser.role}</div>
                    </div>
                    <img src="${currentUser.googleInfo.picture || '/api/placeholder/32/32'}" alt="${currentUser.name}" class="w-8 h-8 rounded-full ml-3">
                `;
            }
            
            // 重新生成部門選擇器
            generateDeptSelector();
            generateCrossProjectTags();
            
            // 更新權限顯示
            updatePermissionDisplay();
        }

        // 更新權限顯示
        function updatePermissionDisplay() {
            const currentUser = window.CURRENT_USER;
            if (!currentUser) return;
            
            const statusDiv = document.getElementById('permission-status-display');
            if (statusDiv) {
                if (currentUser.canViewAll || currentUser.role === 'manager') {
                    statusDiv.innerHTML = '✅ 完整管理權限';
                    statusDiv.className = 'text-xs text-green-600 mt-1';
                } else {
                    const deptName = window.DEPT_PERMISSION_SYSTEM.departments[currentUser.department]?.name;
                    statusDiv.innerHTML = `👥 ${deptName} 成員權限`;
                    statusDiv.className = 'text-xs text-blue-600 mt-1';
                }
            }
        }

        // 生成部門選擇器
        function generateDeptSelector() {
            const select = document.getElementById('task-dept');
            if (!select) return;
            
            const currentUser = window.CURRENT_USER || window.DEPT_PERMISSION_SYSTEM.users['user_member'];
            const departments = Object.values(window.DEPT_PERMISSION_SYSTEM.departments);
            
            // 只顯示當前使用者有權限的部門
            const allowedDepts = departments.filter(dept => {
                return checkDepartmentPermission(currentUser.id, 'create', dept.id);
            });
            
            let options = '<option value="">🏢 選擇部門（公開）</option>';
            
            allowedDepts.forEach(dept => {
                options += `<option value="${dept.id}" data-emoji="${dept.emoji}" data-color="${dept.color}">
                    ${dept.emoji} ${dept.name}
                </option>`;
            });
            
            select.innerHTML = options;
        }

        // 生成跨部門專案標籤
        function generateCrossProjectTags() {
            const container = document.getElementById('cross-project-tags');
            if (!container) return;
            
            const currentUser = window.CURRENT_USER || window.DEPT_PERMISSION_SYSTEM.users['user_member'];
            const crossTags = window.DEPT_PERMISSION_SYSTEM.crossProjectTags;
            
            let html = '';
            
            Object.values(crossTags).forEach(tag => {
                const hasPermission = checkCrossProjectPermission(currentUser.id, tag.id);
                
                if (hasPermission) {
                    html += `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer hover:scale-105 transition-transform cross-dept-tag" 
                              data-tag-id="${tag.id}"
                              style="background-color: ${tag.color}20; color: ${tag.color}; border: 1px dashed ${tag.color};"
                              onclick="toggleCrossProjectTag(this)"
                              title="${tag.description}">
                            ${tag.emoji} ${tag.name}
                        </span>
                    `;
                }
            });
            
            container.innerHTML = html;
            updateSelectedCrossTags();
        }

        // 切換跨部門專案標籤
        function toggleCrossProjectTag(element) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                element.style.backgroundColor = element.style.color;
                element.style.color = 'white';
                element.style.borderStyle = 'solid';
            } else {
                element.style.backgroundColor = element.style.color + '20';
                element.style.color = element.style.color;
                element.style.borderStyle = 'dashed';
            }
            
            updateSelectedCrossTags();
        }

        // 更新已選擇的跨部門標籤顯示
        function updateSelectedCrossTags() {
            const container = document.getElementById('selected-cross-tags');
            const selectedTags = document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected');
            
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-slate-400 text-xs">未選擇跨部門專案</span>';
            } else {
                let html = '<div class="flex flex-wrap gap-1">';
                selectedTags.forEach(tag => {
                    const tagId = tag.getAttribute('data-tag-id');
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        html += `<span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                        style="background-color: ${tagData.color}; color: white;">
                            ${tagData.emoji} ${tagData.name}
                        </span>`;
                    }
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        // 通知功能
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const colors = {
                success: 'background-color: #10B981; color: white;',
                error: 'background-color: #EF4444; color: white;',
                warning: 'background-color: #F59E0B; color: white;',
                info: 'background-color: #3B82F6; color: white;'
            };
            
            notification.style.cssText += colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</head>
<body class="antialiased">
    <!-- Google Sign-In Button -->
    <div class="g_id_signin" 
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>

    <!-- 部門權限控制面板 -->
    <div id="dept-control-panel" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-lg mb-6 shadow-lg">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <h3 class="text-lg font-semibold mb-2">🔐 部門權限控制中心</h3>
                <div class="flex items-center gap-3 flex-wrap">
                    <span><strong>使用者：</strong> <span id="current-user-name">未登入</span></span>
                    <span id="current-user-dept" class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-white bg-opacity-20">
                        👤 未設定
                    </span>
                    <span id="permission-status-display" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">
                        請先登入
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div>
                    <label class="block text-xs opacity-80 mb-1">🔍 部門篩選</label>
                    <div id="dept-filter-container">
                        <select id="enterprise-dept-filter" class="bg-white bg-opacity-20 border border-white border-opacity-30 rounded px-3 py-1 text-sm text-white">
                            <option value="">🏢 全部部門</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white bg-opacity-10 p-2 rounded">
                    <div class="text-xs opacity-80">權限狀態</div>
                    <div id="permission-scope" class="text-sm font-semibold">檢視中</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要內容區域 -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 tracking-tight">智慧週報平台</h1>
                    <p class="text-slate-500 mt-3">您的專屬任務管理中心，讓工作流程更順暢。</p>
                </div>
                <div id="user-profile" class="text-right">
                    <!-- 使用者資訊將由JavaScript動態載入 -->
                </div>
            </div>
            <div id="offline-status" class="hidden mt-4 text-sm font-semibold text-amber-800 bg-amber-100 p-3 rounded-lg items-center justify-center max-w-md mx-auto shadow-sm border border-amber-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1V8a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span id="offline-message">系統已離線，部分功能可能受限。</span>
            </div>
        </header>

        <!-- 新增任務表單 - 含部門選擇 -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200/50 mb-10">
            <h2 class="text-xl font-semibold mb-6 text-slate-800">新增一項任務</h2>
            <form id="add-task-form" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="add-task-priority" class="block text-sm font-medium text-slate-600 mb-1.5">優先度</label>
                        <select id="add-task-priority" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                            <option value="">選擇優先度</option>
                            <option value="緊急">緊急</option>
                            <option value="高">高</option>
                            <option value="中">中</option>
                            <option value="低">低</option>
                        </select>
                    </div>
                    <div>
                        <label for="add-task-assignee" class="block text-sm font-medium text-slate-600 mb-1.5">負責人</label>
                        <input type="text" id="add-task-assignee" list="assignee-list" placeholder="輸入或選擇..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                    </div>
                    <div>
                        <label for="add-task-due-date" class="block text-sm font-medium text-slate-600 mb-1.5">截止日期 (可選)</label>
                        <input type="date" id="add-task-due-date" class="custom-input w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-1.5">負責部門</label>
                        <div id="dept-selection-container">
                            <select id="task-dept" class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition">
                                <!-- 部門選項將由JavaScript動態生成 -->
                            </select>
                        </div>
                        <div id="dept-permission-status" class="text-xs text-slate-500 mt-1"></div>
                    </div>
                </div>
                
                <div>
                    <label for="add-task-title" class="block text-sm font-medium text-slate-600 mb-1.5">任務標題</label>
                    <input type="text" id="add-task-title" placeholder="請輸入任務標題..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition" required>
                </div>
                
                <div>
                    <label for="add-task-desc" class="block text-sm font-medium text-slate-600 mb-1.5">任務描述 (可選)</label>
                    <textarea id="add-task-desc" rows="3" placeholder="請輸入任務描述..." class="custom-input w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition"></textarea>
                </div>
                
                <!-- 跨部門專案標籤 -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1.5">跨部門專案標籤 (可選)</label>
                    <div style="background-color: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <p style="color: #64748b; font-size: 13px; margin: 0 0 8px 0;">點擊下方標籤添加跨部門協作：</p>
                        <div id="cross-project-tags" class="flex flex-wrap gap-2 mb-3">
                            <!-- 跨部門標籤將由JavaScript動態生成 -->
                        </div>
                        <div id="selected-cross-tags" class="min-h-[24px] border-t border-dashed border-slate-300 pt-2">
                            <span class="text-slate-400 text-xs">未選擇跨部門專案</span>
                        </div>
                    </div>
                </div>
                
                <p id="status-message" class="text-sm text-center text-slate-500 h-5"></p>
                <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300/80">新增任務</button>
            </form>
        </div>

        <!-- 任務列表 -->
        <div class="mb-6">
            <div class="flex justify-between items-center px-2 mb-4">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h3.586a1 1 0 01.707.293l.724.724A1 1 0 0111 2H13a1 1 0 100 2H7a3 3 0 00-3 3v1a1 1 0 011 1h4a1 1 0 001-1V6a1 1 0 112 0v1a2 2 0 002 2h8a2 2 0 002-2V5a1 1 0 10-2 0v1H4V5zM3 13a1 1 0 011-1h4a1 1 0 001-1v8a2 2 0 002 2h6a2 2 0 002-2v-8a1 1 0 112 0v8a3 3 0 01-3 3H7a3 3 0 01-3-3v-8z" clip-rule="evenodd" />
                    </svg>待辦事項
                </h2>
                <div id="sort-controls" class="flex items-center space-x-1 bg-slate-100 p-1 rounded-lg">
                    <button data-sort="priority" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors">優先度</button>
                    <button data-sort="createdAt" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">建立日期</button>
                    <button data-sort="dueDate" class="sort-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors text-slate-500">到期日期</button>
                </div>
            </div>
            <div id="todo-list" class="space-y-4 min-h-[150px]">
                <!-- 任務將由JavaScript動態生成 -->
            </div>
        </div>

        <div class="space-y-2">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2.5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>已處理
                </h2>
                <button id="clear-completed-btn" class="text-sm text-rose-600 hover:text-rose-800 font-semibold transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1V8a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>清除
                </button>
            </div>
            <div id="completed-list" class="space-y-4">
                <!-- 已完成的任務將由JavaScript動態生成 -->
            </div>
        </div>
    </div>

    <!-- 資料清單 -->
    <datalist id="assignee-list"></datalist>

    <!-- JavaScript 功能整合 -->
    <script>
        // ===== 系統初始化 =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // 初始化部門選擇器
            generateDeptSelector();
            generateCrossProjectTags();
            
            // 設定表單提交
            setupFormSubmission();
            
            // 載入現有任務
            loadExistingTasks();
            
            // 設定事件監聽器
            setupEventListeners();
        }

        // ===== 部門功能 =====
        function generateDeptSelector() {
            const select = document.getElementById('task-dept');
            if (!select) return;
            
            const departments = Object.values(window.DEPT_PERMISSION_SYSTEM.departments);
            let options = '<option value="">🏢 選擇部門（公開）</option>';
            
            departments.forEach(dept => {
                options += `<option value="${dept.id}" data-emoji="${dept.emoji}" data-color="${dept.color}">
                    ${dept.emoji} ${dept.name}
                </option>`;
            });
            
            select.innerHTML = options;
        }

        function generateCrossProjectTags() {
            const container = document.getElementById('cross-project-tags');
            if (!container) return;
            
            const crossTags = window.DEPT_PERMISSION_SYSTEM.crossProjectTags;
            let html = '';
            
            Object.values(crossTags).forEach(tag => {
                html += `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm cursor-pointer hover:scale-105 transition-transform cross-dept-tag" 
                          data-tag-id="${tag.id}"
                          style="background-color: ${tag.color}20; color: ${tag.color}; border: 1px dashed ${tag.color};"
                          onclick="toggleCrossProjectTag(this)"
                          title="${tag.description}">
                        ${tag.emoji} ${tag.name}
                    </span>
                `;
            });
            
            container.innerHTML = html;
            updateSelectedCrossTags();
        }

        function toggleCrossProjectTag(element) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                element.style.backgroundColor = element.style.color;
                element.style.color = 'white';
                element.style.borderStyle = 'solid';
            } else {
                element.style.backgroundColor = element.style.color + '20';
                element.style.color = element.style.color;
                element.style.borderStyle = 'dashed';
            }
            
            updateSelectedCrossTags();
        }

        function updateSelectedCrossTags() {
            const container = document.getElementById('selected-cross-tags');
            const selectedTags = document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected');
            
            if (selectedTags.length === 0) {
                container.innerHTML = '<span class="text-slate-400 text-xs">未選擇跨部門專案</span>';
            } else {
                let html = '<div class="flex flex-wrap gap-1">';
                selectedTags.forEach(tag => {
                    const tagId = tag.getAttribute('data-tag-id');
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        html += `<span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                        style="background-color: ${tagData.color}; color: white;">
                            ${tagData.emoji} ${tagData.name}
                        </span>`;
                    }
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        // ===== 表單提交處理 =====
        function setupFormSubmission() {
            const form = document.getElementById('add-task-form');
            if (!form) return;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const currentUser = window.CURRENT_USER;
                if (!currentUser) {
                    showNotification('❌ 請先登入Google帳號！', 'error');
                    return false;
                }
                
                const deptSelect = document.getElementById('task-dept');
                const selectedDepartment = deptSelect ? deptSelect.value : '';
                
                // 檢查部門權限
                if (selectedDepartment && !checkDepartmentPermission(currentUser.id, 'create', selectedDepartment)) {
                    showNotification('❌ 您沒有在該部門創建任務的權限！', 'error');
                    return false;
                }
                
                // 收集跨部門標籤
                const selectedCrossTags = Array.from(document.querySelectorAll('#cross-project-tags .cross-dept-tag.selected'))
                    .map(tag => tag.getAttribute('data-tag-id'));
                
                // 建立任務資料
                const taskData = {
                    title: document.getElementById('add-task-title')?.value,
                    description: document.getElementById('add-task-desc')?.value,
                    priority: document.getElementById('add-task-priority')?.value,
                    assignee: document.getElementById('add-task-assignee')?.value,
                    dueDate: document.getElementById('add-task-due-date')?.value,
                    department: selectedDepartment,
                    crossDeptTags: selectedCrossTags,
                    creatorId: currentUser.id,
                    creatorName: currentUser.name,
                    creatorDept: currentUser.department,
                    status: 'todo',
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const newTask = await createTask(taskData);
                    if (newTask) {
                        showNotification('✅ 任務創建成功！', 'success');
                        form.reset();
                        updateSelectedCrossTags();
                        loadExistingTasks();
                    }
                } catch (error) {
                    showNotification(`❌ 任務創建失敗：${error.message}`, 'error');
                }
                
                return false;
            };
        }

        // 創建任務
        async function createTask(taskData) {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const newTask = {
                id: 'task_' + Date.now(),
                ...taskData,
                updatedAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            return newTask;
        }

        // ===== 任務載入與顯示 =====
        function loadExistingTasks() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const currentUser = window.CURRENT_USER;
            
            if (!currentUser) {
                // 未登入時顯示所有任務
                displayTasks(tasks);
                return;
            }
            
            // 登入後根據權限過濾任務
            const filteredTasks = tasks.filter(task => {
                if (!task.department) return true; // 沒有部門的任務所有人都可以看到
                
                // 檢查部門權限
                return checkDepartmentPermission(currentUser.id, 'view', task.department);
            });
            
            displayTasks(filteredTasks);
        }

        function displayTasks(tasks) {
            const todoList = document.getElementById('todo-list');
            const completedList = document.getElementById('completed-list');
            
            if (!todoList || !completedList) return;
            
            todoList.innerHTML = '';
            completedList.innerHTML = '';
            
            const currentUser = window.CURRENT_USER;
            
            tasks.forEach(task => {
                const taskElement = createTaskElement(task, currentUser);
                
                if (task.status === 'completed') {
                    completedList.appendChild(taskElement);
                } else {
                    todoList.appendChild(taskElement);
                }
            });
        }

        function createTaskElement(task, currentUser) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-4 rounded-lg shadow-sm border border-slate-200';
            taskCard.setAttribute('data-task-id', task.id);
            taskCard.setAttribute('data-department', task.department || '');
            
            // 根據權限調整顯示
            if (task.department && currentUser && !checkDepartmentPermission(currentUser.id, 'view', task.department)) {
                taskCard.style.opacity = '0.6';
                taskCard.style.pointerEvents = 'none';
                taskCard.style.backgroundColor = '#f8fafc';
            }
            
            // 部門標籤
            let deptTagHtml = '';
            if (task.department) {
                const dept = window.DEPT_PERMISSION_SYSTEM.departments[task.department];
                if (dept) {
                    deptTagHtml = `
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-2 mb-2" 
                              style="background-color: ${dept.color}20; color: ${dept.color}; border: 1px solid ${dept.color};">
                            ${dept.emoji} ${dept.name}
                        </span>
                    `;
                }
            }
            
            // 跨部門標籤
            let crossTagsHtml = '';
            if (task.crossDeptTags && task.crossDeptTags.length > 0) {
                crossTagsHtml = '<div class="flex flex-wrap gap-1 mt-2">';
                task.crossDeptTags.forEach(tagId => {
                    const tagData = window.DEPT_PERMISSION_SYSTEM.crossProjectTags[tagId];
                    if (tagData) {
                        crossTagsHtml += `
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs" 
                                  style="background-color: ${tagData.color}; color: white;">
                                ${tagData.emoji} ${tagData.name}
                            </span>
                        `;
                    }
                });
                crossTagsHtml += '</div>';
            }
            
            // 權限提示
            let permissionNotice = '';
            if (task.department && currentUser && !checkDepartmentPermission(currentUser.id, 'view', task.department)) {
                permissionNotice = `
                    <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600">
                        🔒 您沒有查看此部門任務的權限
                    </div>
                `;
            }
            
            taskCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        ${deptTagHtml}
                        <h3 class="task-title text-lg font-semibold text-slate-800">${task.title}</h3>
                        ${crossTagsHtml}
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        ${task.priority ? `<span class="priority-badge priority-${task.priority} px-2 py-1 rounded-full text-xs font-medium">${task.priority}</span>` : ''}
                        <button onclick="expandTaskDetails('${task.id}')" class="p-1 text-slate-400 hover:text-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 expand-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="task-details">
                    ${task.description ? `<p class="text-slate-600 mb-3">${task.description}</p>` : ''}
                    <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                        ${task.assignee ? `<span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>${task.assignee}</span>` : ''}
                        ${task.dueDate ? `<span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                    </div>
                    ${permissionNotice}
                </div>
                
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-100">
                    <div class="flex gap-2">
                        <button onclick="updateTaskStatus('${task.id}', 'completed')" class="px-3 py-1 bg-emerald-500 text-white text-sm rounded hover:bg-emerald-600 transition-colors">完成</button>
                        <button onclick="editTask('${task.id}')" class="px-3 py-1 bg-slate-500 text-white text-sm rounded hover:bg-slate-600 transition-colors">編輯</button>
                        <button onclick="deleteTask('${task.id}')" class="px-3 py-1 bg-rose-500 text-white text-sm rounded hover:bg-rose-600 transition-colors">刪除</button>
                    </div>
                    <span class="text-xs text-slate-500">建立者：${task.creatorName || '系統'}</span>
                </div>
            `;
            
            return taskCard;
        }

        // ===== 事件處理 =====
        function setupEventListeners() {
            // 部門篩選變更
            const deptFilter = document.getElementById('enterprise-dept-filter');
            if (deptFilter) {
                deptFilter.addEventListener('change', function() {
                    filterTasksByDepartment(this.value);
                });
            }
            
            // 其他事件監聽器
            const clearBtn = document.getElementById('clear-completed-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearCompletedTasks);
            }
        }

        // 根據部門篩選任務
        function filterTasksByDepartment(selectedDeptId) {
            const tasks = document.querySelectorAll('.task-card');
            const currentUser = window.CURRENT_USER;
            
            tasks.forEach(task => {
                const taskDeptId = task.getAttribute('data-department');
                let shouldShow = true;
                
                // 部門篩選
                if (selectedDeptId && selectedDeptId !== '') {
                    shouldShow = taskDeptId === selectedDeptId;
                }
                
                // 權限檢查（只在有使用者登入時）
                if (currentUser && taskDeptId && !checkDepartmentPermission(currentUser.id, 'view', taskDeptId)) {
                    shouldShow = false;
                }
                
                task.style.display = shouldShow ? 'block' : 'none';
                
                // 視覺提示
                if (!shouldShow && taskDeptId) {
                    task.classList.add('restricted');
                } else {
                    task.classList.remove('restricted');
                }
            });
        }

        // 其他功能函數
        function expandTaskDetails(taskId) {
            // 實作任務詳細資訊展開功能
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.classList.toggle('expanded');
            }
        }

        function updateTaskStatus(taskId, status) {
            // 實作任務狀態更新功能
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1) {
                tasks[taskIndex].status = status;
                tasks[taskIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadExistingTasks();
            }
        }

        function editTask(taskId) {
            // 實作任務編輯功能
            showNotification('✅ 編輯功能開發中...', 'info');
        }

        function deleteTask(taskId) {
            // 實作任務刪除功能
            if (confirm('確定要刪除此任務嗎？')) {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const filteredTasks = tasks.filter(task => task.id !== taskId);
                localStorage.setItem('tasks', JSON.stringify(filteredTasks));
                loadExistingTasks();
                showNotification('✅ 任務已刪除', 'success');
            }
        }

        function clearCompletedTasks() {
            if (confirm('確定要清除所有已完成的任務嗎？')) {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const filteredTasks = tasks.filter(task => task.status !== 'completed');
                localStorage.setItem('tasks', JSON.stringify(filteredTasks));
                loadExistingTasks();
                showNotification('✅ 已完成任務已清除', 'success');
            }
        }

        // ===== 通知功能 =====
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const colors = {
                success: 'background-color: #10B981; color: white;',
                error: 'background-color: #EF4444; color: white;',
                warning: 'background-color: #F59E0B; color: white;',
                info: 'background-color: #3B82F6; color: white;'
            };
            
            notification.style.cssText += colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // ===== 初始化 =====
        window.addEventListener('load', function() {
            // 初始化系統
            initializeSystem();
            
            // 檢查是否有已登入的使用者
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                window.CURRENT_USER = JSON.parse(savedUser);
                updateUIAfterLogin();
            }
        });
    </script>
</body>
</html>

